most-search-masks-data-simple.xmlmost-search-masks-data-simple.xml<?xml version="1.0" encoding="UTF-8"?>
<import revision="$LastChangedRevision: 9299 $">		
<!-- DEFAULT SCRIPTS -->
<objects>
    <object code="most.import_companies.xls.filter-script" objectdef="vscript" module="core" >
    				<package mode="delete"/>
                    <params>
                        <value>
                            <object code="lines" module="core" objectdef="script_param"/>
                        </value>
                        <value>
                            <object code="row" module="core" objectdef="script_param"/>
                        </value>
                        <value>
                            <object code="nameToCol" module="core" objectdef="script_param"/>
                        </value>
                    </params>            
                    <script_code>    
                        <value><![CDATA[
//lines,row,nameToCol
var line = lines[row];
var colBid = nameToCol["Bid"];
var colCmp = nameToCol["Име на фирма"];
var colBul = nameToCol["Булстат"];
if (line[colCmp] == null || line[colCmp].trim() == "")
	return false;
try {
    line[colBid].castToExactNumber();    
} catch(e) {
    return false;
}
return true;                        
         ]]></value>
     </script_code>
 </object>
 
 <object code="gen.bg2lat" objectdef="vscript" module="core" >
     <params>
         <value>
             <object code="str" module="core" objectdef="script_param"/>
         </value>
     </params>            
     <script_code>    
         <value><![CDATA[
var arr=[];
var ll = str.length();
for (var i=0;i<ll;i++) {
	var c = str[i];
	function ns() {
		return (i < ll-1 && str[i+1] >= "а" && str[i+1] <= "я"); 
	}
	if (c == "Ж") {
		if (ns()) {
			arr.push("Zh");
		} else {
			arr.push("ZH");
		}
	} else if (c == "Ч") {
		if (ns()) {
			arr.push("Ch");
		} else {
			arr.push("CH");
		}
	} else if (c == "Ш") {
		if (ns()) {
			arr.push("Sh");
		} else {
			arr.push("SH");
		}
	} else if (c == "Щ") {
		if (ns()) {
			arr.push("St");
		} else {
			arr.push("ST");
		}
	} else if (c == "Ю") {
		if (ns()) {
			arr.push("Ju");
		} else {
			arr.push("JU");
		}
	// ----------------------		
	} else if (c == "ж") {
		arr.push("zh");
	} else if (c == "ч") {
		arr.push("ch");
	} else if (c == "ш") {
		arr.push("sh");
	} else if (c == "щ") {
		arr.push("st");
	} else if (c == "ю") {
		arr.push("ju");
	}
	//----------------------
	else {
		arr.push(c);
	}
}          
return arr.join("")

	.replace("Йо","Jo")
	.replace("ЙО","JO")
	.replace("йо","jo")
	.replace("йО","jO")
	
	.replace("Ьо","Jo")
	.replace("ЬО","JO")
	.replace("ьо","jo")
	.replace("ьО","jO")
	
	.replace("А","A")
	.replace("Б","B")
	.replace("В","V")
	.replace("Г","G")
	.replace("Д","D")
	.replace("Е","E")
	.replace("З","Z")
	.replace("И","I")
	.replace("К","K")
	.replace("Л","L")
	.replace("М","M")
	.replace("Н","N")
	.replace("О","O")
	.replace("П","P")
	.replace("Р","R")
	.replace("С","S")
	.replace("Т","T")
	.replace("У","U")
	.replace("Ф","F")
	.replace("Ц","C")
	.replace("Ъ","A")
	.replace("Я","Q")

	.replace("а","a")
	.replace("б","b")
	.replace("в","v")
	.replace("г","g")
	.replace("д","d")
	.replace("е","e")
	.replace("з","z")
	.replace("и","i")
	.replace("к","k")
	.replace("л","l")
	.replace("м","m")
	.replace("н","n")
	.replace("о","o")
	.replace("п","p")
	.replace("р","r")
	.replace("с","s")
	.replace("т","t")
	.replace("у","u")
	.replace("ф","f")
	.replace("ц","c")
	.replace("ъ","a")
	.replace("я","q")

	
	.replace("Й","I")
	.replace("й","i")
	.replace("Ь","I")
	.replace("ь","i");
         ]]></value>
     </script_code>
 </object>
 
 <object code="availOpg" objectdef="vscript" module="core" >
     <params>
         <value>
             <object code="object" module="core" objectdef="script_param"/>
         </value>
     </params>            
     <script_code>    
         <value><![CDATA[
var rest = object.quantity;
var params = new M();
var sel = db.most.opg.SELECT("discount_mode.code = 'R' AND (valid_from IS NULL OR valid_from <= :OFCD) AND (valid_to IS NULL OR valid_to >= :OFCD) AND entries.article.id = :PRID ORDER BY COALESCE(valid_to,valid_from),id DESC");
sel["OFCD"]=object.official_date.date;
sel["PRID"]=object.article.id;
var arr=[];
var ok=false;
for (var e : sel.VALUE) 
{
	if (e == object.opg)
		continue;
	for (var a : e.entries) 
	{
		if (a.article == object.article) 
		{
			if (a.max_quantity == null) 
			{
				arr.push(e);
				break;
			} else {
				var q = a.max_quantity;
			 	var params = new M();
			 	params["ID"]=e.id;
			 	var sl = db.most.protocol_sale.VSQL_QUERY_SUM("SELECT quantity AS VAL WHERE opg = :ID",params);
				var used = 0;
				if (sl.next()) {
			        used=sl.getInt("RES");
			        if (used == null)
			        	used=0;
			    }
			    q-=used;
			    if (q < 0) {
					java.log.error("Inconsistent quantity state2 : "+a.toString());					    
			    } else if (rest <= q) {
					arr.push(e);
					break;
				} 	
			}
		}
	}
}
return arr;
         ]]></value>
     </script_code>
 </object>
 
 
  <object code="syncEDI" objectdef="vscript" module="core" >             
     <script_code>    
         <value><![CDATA[
/*system.vsp("<%vsp:include script=\"${web.lib.dir}/most/getstock.vr\" />");
system.vsp("<%vsp:include script=\"${web.lib.dir}/most/getopg.vr\" />");*/
java.log.error("OPLA : "+java.date.now());
         ]]></value>
     </script_code>
 </object>
 
</objects>
</import>