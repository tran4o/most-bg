<?xml version="1.0" encoding="UTF-8"?>
<!--+
    | Main import file for the module test.
    |
    | Date:    $LastChangedDate: 2012-02-22 11:49:00 +0100 (Mi, 22 Feb 2012) $ 
    | Version: $LastChangedRevision: 12142 $
    +-->

<import revision="$LastChangedRevision: 12142 $" xmlns:xi="http://www.w3.org/2001/XInclude">
<objectdefs>

	<most module_alias="m" use_prefix="true">
		
		<bill_date mode="delete"/>
		<hold_in mode="delete"/>
		<hold_out mode="delete"/>
		<report_date mode="delete"/>
		<category_date mode="delete"/>				

		<protocol tbl="prt" copy_from="core.template_normal_transaction" is_abstract="true">
			 <date mode="delete"/>
			 <bill_date mode="delete"/>
			 <report_date mode="delete"/>
			 <price_discount mode="delete"/>
	 		 <code is_keep_settings="true">
				<is_unique>true</is_unique>
			 </code>
			 <quantity>
				<category>main.basic</category>
				<display_type>property:most.protocol.quantity</display_type>
                <sort_id>100</sort_id>
			 	<data_source>input</data_source>
			 	<data_type>integer</data_type>
			 	<is_obligatory>true</is_obligatory>
				<min_value_integer>1</min_value_integer>			 	
                <is_inmaintbl>true</is_inmaintbl>
				<name>
                    <en-US>Quantity</en-US>
                </name>
                <name>
                    <de-DE>Quantität</de-DE>
                </name>
                <name>
                    <bg-BG>Количесто</bg-BG>
                </name>      
                <on_update_value>
                    <object code="most.protocol:recalc_total" module="core" objectdef="vscript">                       
                        <script_code>
                            <value><![CDATA[
if (this.quantity != null && (this.price != null || this["price_discount"] != null))
	this.total = this.quantity * (this["price_discount"] != null ? this.price_discount : this.price);
else
	this.total=0;
                        ]]></value>
                        </script_code>
                    </object>
                </on_update_value>
			 </quantity>
			
			 <article>
				<category>main.basic</category>
				<display_type>property:most.protocol_sale.article</display_type>
                <sort_id>100</sort_id>
                <data_source>relation</data_source>
			 	<related_objectdef>most.article</related_objectdef>
			 	<is_obligatory>true</is_obligatory>			 	
                <is_inmaintbl>true</is_inmaintbl>
                <index_code>a</index_code>
  				<name>
                    <en-US>Article</en-US>
                </name>
                <name>
                    <de-DE>Artikel</de-DE>
                </name>
                <name>
                    <bg-BG>Артикул</bg-BG>
                </name>                
			 </article>

			 <price col="prc">
				<category>main.basic</category>
                <sort_id>101</sort_id>
			 	<data_source>input</data_source>
			 	<data_type>double</data_type>
				<min_value_double>0</min_value_double>			 	
                <is_inmaintbl>true</is_inmaintbl>
                <is_readonly>false</is_readonly>
				<name>
                    <en-US>Price</en-US>
                </name>
                <name>
                    <de-DE>Preis</de-DE>
                </name>
                <name>
                    <bg-BG>Цена</bg-BG>
                </name>      
                <on_update_value>
                    <object code="most.protocol:recalc_total" module="core" objectdef="vscript"/>                                          
                </on_update_value>
  				<on_insert_value>
                    <object code="most.protocol:recalc_total" module="core" objectdef="vscript"/>                       
                </on_insert_value>                
			 </price>
			 			
			 <total>
				<category>main.basic</category>
                <sort_id>102</sort_id>
                <data_source>input</data_source>
                <data_type>double</data_type>
                <is_readonly>true</is_readonly>
                <is_inmaintbl>true</is_inmaintbl>
  				<name>
                    <en-US>Total</en-US>
                </name>
                <name>
                    <de-DE>Total</de-DE>
                </name>
                <name>
                    <bg-BG>Общо</bg-BG>
                </name> 
                <default_value>0</default_value>  
			 </total>

			 <opg>
                <category>main.basic</category>
                <sort_id>9000</sort_id>
                <is_inmaintbl>true</is_inmaintbl>
                <data_source>relation</data_source>
                <related_objectdef>most.opg</related_objectdef>
                <name>
                    <en-US>OPG</en-US>
                </name>
                <index_code>og</index_code>               
    			<on_insert_value>
                    <object code="most.protocol.opg:on_change" module="core" objectdef="vscript">
						 <params>
                              <value>
                                 <object code="object" module="core" objectdef="script_param"></object>
                             </value>
                             <value>
                                 <object code="property" module="core" objectdef="script_param"></object>
                             </value>
                         </params>
                         <script_code>
                             <value><![CDATA[
if (this.opg == null)
	this.opg_entry=null;
else {
	this.opg_entry=null;
	for (var e : this.opg.entries) if (e.article == this.article) {
		this.opg_entry=e;
		break;
	}
	if (this.opg_entry == null) {
		this.opg=null; 
		java.log.error("OPG ENTRY NOT FOUND! Reset opg to null | "+this.toString());
	}
}
                          ]]></value>
                          </script_code>                    
                    </object>                                          
               </on_insert_value>			
               <on_update_value>
                    <object code="most.protocol.opg:on_change" module="core" objectdef="vscript"/>                                          
                </on_update_value>			
               <on_delete_value>
                    <object code="most.protocol.opg:on_change" module="core" objectdef="vscript"/>                                          
                </on_delete_value>			
			 </opg>      
			 
			 <opg_entry>
                <category>main.basic</category>
                <sort_id>9000</sort_id>
                <is_inmaintbl>true</is_inmaintbl>
                <data_source>relation</data_source>
                <is_readonly>true</is_readonly>
                <related_objectdef>most.opg_entry</related_objectdef>
                <name>
                    <en-US>OPG Entry</en-US>
                    <de-DE>OPG Eintrag</de-DE>
                    <bg-BG>OPG запис</bg-BG>
                </name>
                <index_code>oge</index_code>               
			 </opg_entry>            
			 
			 <real_date>
                <category>main.settings</category>
                <sort_id>150</sort_id>
                <is_inmaintbl>true</is_inmaintbl>
                <data_source>relation</data_source>
                <related_objectdef>most.protocol_date</related_objectdef>
                <rel_display_string_order>is_active DESC,"date"</rel_display_string_order>                
                <name>
                    <en-US>Real date</en-US>
                </name>
                <name>
                    <de-DE>Reales datum</de-DE>
                </name>
                <name>
                    <bg-BG>Реална дата</bg-BG>
                </name>
                <is_obligatory>true</is_obligatory>
                <default_value_calculation>
                    <object code="most.proctol.real_date:default_value_calculation" module="core" objectdef="vscript">
                        <params>
                            <value>
                                <object code="id" module="core" objectdef="script_param" proj="all"></object>
                            </value>
                        </params>
                        <script_code>
                            <value><![CDATA[
var x = db.most.protocol_date.selectWhere("is_active = 1");
if (x.size == 1)
	return x[0];
return null;                            
                            ]]></value>
                        </script_code>
                    </object>
                </default_value_calculation>
                <index_code>isd</index_code>
 				<relation_filter>
                     <object code="most.COMMON.protocol_date_filter:basic" module="core" objectdef="relation_filter">
                        <get_related_objectdef_condition>
                            <value>
                                <object code="most.COMMON.protocol_date_filter:basic:get_related_objectdef_condition" module="core" objectdef="vscript">
                                    <params>
                                         <value>
                                            <object code="object" module="core" objectdef="script_param"></object>
                                        </value>
                                        <value>
                                            <object code="property" module="core" objectdef="script_param"></object>
                                        </value>
                                    </params>
                                    <script_code>
                                        <value><![CDATA[
return "((is_active=1 OR is_show=1) AND \"date\" <= CURRENT_TIMESTAMP)";
                                    ]]></value>
                                    </script_code>
                                </object>
                            </value>
                        </get_related_objectdef_condition>
                   </object>
               </relation_filter>             
             </real_date>
			 
     		 <official_date>
				<display_type>property:most.protocol.official_date</display_type>
                <category>main.settings</category>
                <sort_id>150</sort_id>
                <is_inmaintbl>true</is_inmaintbl>
                <data_source>relation</data_source>
                <rel_display_string_order>is_active DESC,"date"</rel_display_string_order>                
                <related_objectdef>most.protocol_date</related_objectdef>
                <name>
                    <en-US>Official date</en-US>
                </name>
                <name>
                    <de-DE>Offizieles Datum</de-DE>
                </name>
                <name>
                    <bg-BG>Официална дата</bg-BG>
                </name>                             
                <index_code>pd</index_code>
                <relation_filter>
                     <object code="most.COMMON.protocol_date_filter:basic" module="core" objectdef="relation_filter"/>
                </relation_filter>
                <on_update_value>
                    <object code="most.protocol.official_date:on_update_value" module="core" objectdef="vscript">                       
                        <script_code>
                            <value><![CDATA[
                             
                        ]]></value>
                        </script_code>
                    </object>
                </on_update_value>
                <on_insert_value>
                    <object code="most.protocol.official_date:on_update_value" module="core" objectdef="vscript"/>                       
                </on_insert_value>
                <on_delete_value>
                    <object code="most.protocol.official_date:on_update_value" module="core" objectdef="vscript"/>                       
                </on_delete_value>
        	</official_date>
        	
        </protocol>
		
		<protocol_sale parent_objectdef="most.protocol">
			 
			 <version mode="delete"/>

			 <real_date is_keep_settings="true">
			 	<is_obligatory>false</is_obligatory>
			 </real_date>
			 			 
			 <most_sale_id>
                <category>main.basic</category>
                <sort_id>9100</sort_id>
                <data_source>input</data_source>
                <data_type>varchar</data_type>
                <name>
                    <en-US>Sale ID</en-US>
                    <de-DE>VerkaufsID</de-DE>
                    <bg-BG>ИН продажба</bg-BG>
                </name>
			 </most_sale_id>
			 
			 <odit_entry>
                <category>main.basic</category>
                <sort_id>9000</sort_id>
                <data_source>relation</data_source>
                <is_multiple>false</is_multiple>
                <is_readonly>false</is_readonly>
                <related_objectdef>most.odit_entry</related_objectdef>
                <is_dynamic>true</is_dynamic>
                <name>
                    <en-US>Odit (entry)</en-US>
                    <de-DE>Odit (Eintrag)</de-DE>
                    <bg-BG>Ревизия (запис)</bg-BG>
                </name>
             	<is_dynamic>true</is_dynamic>               
                <calculation>
	     			<object code="most.protocol_sale.odit_entry:calculation_relation_path" module="core" objectdef="calculation_relation_path">
                         <property_code_path>
                             <value>article.odit_entries</value>
                         </property_code_path>
                         <where_statement>
                             <value>article.odit_entries.id IN (SELECT article.odit_entries.id WHERE id = :VR__OUTER_SELECT_ID ORDER BY article.odit_entries.odit."date"."date" DESC LIMIT 1 )</value>
                         </where_statement>
                     </object>
                 </calculation>
             </odit_entry>               
			 
		     <opg is_keep_settings="true">
			   <on_delete_value>
                    <object code="most.protocol_sale.opg:on_change" module="core" objectdef="vscript"/>
               </on_delete_value>                    
               <on_insert_value>
                    <object code="most.protocol_sale.opg:on_change" module="core" objectdef="vscript"/>
               </on_insert_value>                    
               <on_update_value>
                    <object code="most.protocol_sale.opg:on_change" module="core" objectdef="vscript">                       
                        <script_code>
                            <value><![CDATA[
super();
this.recalculate_price();	
                        ]]></value>
                        </script_code>
                    </object>
                </on_update_value>                        
 				<relation_filter>
                     <object code="most.protocol_sale.opg" module="core" objectdef="relation_filter">
                        <get_related_objectdef_condition>
                            <value>
                                <object code="relation_filter:most.protocoL_sale.opg:get_related_objectdef_condition" module="core" objectdef="vscript">
                                    <params>
                                        <value>
                                            <object code="object" module="core" objectdef="script_param"></object>
                                        </value>
                                        <value>
                                            <object code="property" module="core" objectdef="script_param"></object>
                                        </value>
                                    </params>
                                    <script_code>
                                        <value><![CDATA[
if (object.stock == null || object.article == null || object.official_date == null)
	return "0=1";
var arr=[];
var k = SCRIPTS["availOpg"](object);
for (var e : k) 
	arr.push(e.id);
if (arr.is_empty)
	return "0=1";
return "id IN ("+arr.join(",")+")";	
                                    ]]></value>
                                    </script_code>
                                </object>
                            </value>
                        </get_related_objectdef_condition>
                   </object>
               </relation_filter>  			
			</opg>
			
			 <price is_keep_settings="true">
			 	<is_readonly>true</is_readonly>
			 	<is_obligatory>false</is_obligatory>
			 </price>
						        		 
       		 <customer>
                <category>main.basic</category>
                <sort_id>200</sort_id>
                <data_source>relation</data_source>
                <related_objectdef>most.customer</related_objectdef>
                <name>
                    <en-US>Customer</en-US>
                </name>
                <name>
                    <de-DE>Kunde</de-DE>
                </name>
                <name>
                    <bg-BG>Клиент</bg-BG>
                </name>
                <is_obligatory>true</is_obligatory>
                <is_inmaintbl>true</is_inmaintbl>
                <index_code>cr</index_code>
             </customer>
             
             <stock>
				<rel_display_columns>most.protocol.code</rel_display_columns>
             	<rel_display_columns>most.protocol_stock.used_quantity</rel_display_columns>
             	<rel_display_columns>most.protocol_stock.rest_quantity</rel_display_columns>
             	<rel_display_columns>most.protocol.price</rel_display_columns>
             	<rel_display_columns>most.protocol_stock.price_discount</rel_display_columns>
				<rel_display_columns>most.protocol.opg</rel_display_columns>
             
                <category>main.basic</category>
                <sort_id>199</sort_id>
                <data_source>relation</data_source>
                <related_objectdef>most.protocol_stock</related_objectdef>
                <name>
                    <en-US>Stock</en-US>
                </name>
                <name>
                    <de-DE>Belieferung</de-DE>
                </name>
                <name>
                    <bg-BG>Зареждане</bg-BG>
                </name>
                <is_obligatory>false</is_obligatory>
                <is_inmaintbl>true</is_inmaintbl>
                <relation_filter>
                    <object code="most.protocol_stock.stock" module="core" objectdef="relation_filter">
                        <get_related_objectdef_condition>
                            <value>
                                <object code="relation_filter:most.protocoL_sale.stock:get_related_objectdef_condition" module="core" objectdef="vscript">
                                    <params>
                                        <value>
                                            <object code="object" module="core" objectdef="script_param"></object>
                                        </value>
                                        <value>
                                            <object code="property" module="core" objectdef="script_param"></object>
                                        </value>
                                    </params>
                                    <script_code>
                                        <value><![CDATA[
if (object.official_date == null || object.article == null || object.quantity == null || object.quantity <= 0)
	return "0=1";
var rest = object.quantity;
var ew = " AND CAST ((quantity - COALESCE((SELECT SUM(sales.quantity) WHERE id = :VR__OUTER_SELECT_ID AND sales.official_date.\"date\" <= :OFCD ),0) - COALESCE((SELECT SUM(official_value) FROM most.state_adjustment_official WHERE stock = :VR__OUTER_SELECT_ID AND \"date\" <= :OFCD),0)) AS INTEGER) >= :MMIN";
var sel = db.most.protocol_stock.SELECT("official_date.\"date\" <= :OFCD AND article = :PRID "+ew+" ORDER BY official_date.\"date\",id");
sel["OFCD"]=object.official_date.date;
sel["PRID"]=object.article.id;
sel["MMIN"]=rest;
var arr=[];
for (var e : sel.VALUE) 
	arr.push(e.id);
if (arr.is_empty)
	return "0=1";
return "id IN ("+arr.join(",")+")";	
                                    ]]></value>
                                    </script_code>
                                </object>
                            </value>
                        </get_related_objectdef_condition>
                   </object>
               </relation_filter>           
               <on_delete_value>
                    <object code="most.protocol_sale.stock:on_change" module="core" objectdef="vscript"/>
               </on_delete_value>                    
               <on_insert_value>
                    <object code="most.protocol_sale.stock:on_change" module="core" objectdef="vscript"/>
               </on_insert_value>                    
               <on_update_value>
                    <object code="most.protocol_sale.stock:on_change" module="core" objectdef="vscript">                       
                        <script_code>
                            <value><![CDATA[
if (this.opg != null)
	this.opg=null;
this.recalculate_price();	
                        ]]></value>
                        </script_code>
                    </object>
                </on_update_value>
             </stock>
             
            <recalculate_price>
                <is_constant>true</is_constant>
                <data_source>relation</data_source>
                <related_objectdef>core.vscript</related_objectdef>
                <is_hidden>true</is_hidden>
                <default_value>
                    <object code="most.protocol_sale.recalculate_price" objectdef="vscript" module="core" >
                        <script_code>
                            <value><![CDATA[
this.price=0;
if (this.stock == null || this.article == null)
	return;
this.price=this.stock.price_discount != null ? this.stock.price_discount : this.stock.price;
if (this.opg != null) 
{
	var ok=false;
	for (var a : this.opg.entries) 
	{
		if (a.article == this.article) 
		{
			if (a.value == null || a.value < 0)
				continue;
			if (a instanceof db.most.opg_entry_percental) {
				this.price=this.price * a.value / 100.0;
				ok=true;
				break;
			} else {
				this.price=a.value;
				ok=true;
				break;
			}						
		}
	}
	if (!ok) {
		java.log.error("PROTOCOL_SALE : INCONSISTENT OPG "+opg.toString());
	}
}
                                ]]></value>
                        </script_code>
                    </object>               
                </default_value>
            </recalculate_price>

            <auto_assign_stock>
                <category>main.basic</category>
                <sort_id>100002</sort_id>
                <data_source>relation</data_source>
                <related_objectdef>core.embedded_execution_script</related_objectdef>
                <is_constant>true</is_constant>
                <is_hidden>false</is_hidden>
                <display_type>property.relation.script_execution</display_type>
                <name><en-US>Auto assign stock</en-US></name>
                <name><de-DE>Belieferung automatisch zuweisen</de-DE></name>
                <name><bg-BG>Автоматично разпределение зареждане</bg-BG></name>
                <default_value>
                    <object code="most.protocol_sale.auto_assign_stock:default_value:embedded_execution_script" objectdef="embedded_execution_script" module="core">
                       <name>
                            <value>
                                <en-US>Auto assign stock!</en-US>
                            </value>
                            <value>
                                <de-DE>Belieferung automatisch zuweisen!</de-DE>
                            </value>
                            <value>
                                <bg-BG>Автоматично разпределение зареждане!</bg-BG>
                            </value>
                       </name>
                       <is_single_button><value>true</value></is_single_button>
                       <is_skip_confirmation><value>false</value></is_skip_confirmation>
                       <is_auto_close_result><value>false</value></is_auto_close_result> 
                       <is_direct><value>true</value></is_direct>
                       <is_object_obligatory><value>true</value></is_object_obligatory>
                       <param_window_width><value>400</value></param_window_width>
                       <param_window_height><value>200</value></param_window_height>
                       <icon>
                            <value>
                              <object code="/images/objectdefs/icons/color/128/graphics-layer_assignment.png" module="documents" objectdef="icon"></object>
                            </value>
                        </icon>
                        <param_objectdef>
                            <value>
                                <object code="script_execution_context_daily_report_param" cond="module.code='most'" objectdef="objectdef" module="core" mode="update"/>
                            </value>
                        </param_objectdef>                   
                       <execute>
                            <value>
                                <object code="most.protocol_sale.auto_assign_stock:default_value:embedded_execution_script.execute" module="core" objectdef="vscript">
                                    <execution_timeout><value>7200</value></execution_timeout>
                                    <params>
                                        <value>
                                            <object code="objects" module="core" objectdef="script_param"></object>
                                        </value>
                                        <value>
                                            <object code="param" module="core" objectdef="script_param"></object>
                                        </value>
                                    </params>
                                    <script_code>
                                        <value><![CDATA[

if (objects == null) {
	return;
}
var arr=[];
for (var e : objects) {
	arr.push(e.id);
}
if (arr.is_empty)
	return;

for (var s : db.most.protocol_sale.selectWhere("stock IS NULL AND official_date IS NULL AND id IN ("+arr.join(",")+") ORDER BY quantity DESC,real_date")) 
{
	var cr = "CAST ((quantity - COALESCE((SELECT SUM(sales.quantity) WHERE id = :VR__OUTER_SELECT_ID AND sales.official_date.\"date\" <= :OFCD ),0) - COALESCE((SELECT SUM(official_value) FROM most.state_adjustment_official WHERE stock = :VR__OUTER_SELECT_ID AND \"date\" <= :OFCD),0)) AS INTEGER)"; 
	var sel = db.most.protocol_stock.SELECT("official_date.\"date\" <= :OFCD AND article = :PRID AND "+cr+" >= :MMIN ORDER BY official_date.\"date\","+cr+" DESC,id");
	sel["OFCD"]=param.date.date;
	sel["PRID"]=s.article.id;
	sel["MMIN"]=s.quantity;
	sel.is_cached=false;
	if (sel.size != 0) 
	{
		s.stock=sel[0];
		s.official_date=param.date;
		s.commit();
		var opgs = SCRIPTS["availOpg"](s);
		if (!opgs.is_empty)
			s.opg=opgs[0];
		writeln("Assigned stock "+sel[0].code+" to sell "+s.code+" | OPGS : "+opgs.size+"<br/>");
	} else {
		writeln("Can not assign sale : "+s.code+" | QUANTYTY = "+s.quantity+"<br/>");
	}	
}
	
                                        ]]></value>
                                    </script_code>
                                </object>
                            </value>
                        </execute>
                        <is_show_multiple_relation><value>true</value></is_show_multiple_relation>
                        <is_show_single_relation><value>true</value></is_show_single_relation>
                    </object>
                </default_value>
            </auto_assign_stock>	
            
            <clear_stock>
                <category>main.basic</category>
                <sort_id>100002</sort_id>
                <data_source>relation</data_source>
                <related_objectdef>core.embedded_execution_script</related_objectdef>
                <is_constant>true</is_constant>
                <is_hidden>false</is_hidden>
                <display_type>property.relation.script_execution</display_type>
                <name><en-US>Clear stock</en-US></name>
                <name><de-DE>Belieferung entfernen</de-DE></name>
                <name><bg-BG>Премахва на зареждане</bg-BG></name>
                <default_value>
                    <object code="most.protocol_sale.clear_stock:default_value:embedded_execution_script" objectdef="embedded_execution_script" module="core">
                       <name>
                            <value>
                                <en-US>Clear stock!</en-US>
                            </value>
                            <value>
                                <de-DE>Belieferung entfernen!</de-DE>
                            </value>
                            <value>
                                <bg-BG>Премахва на зареждане!</bg-BG>
                            </value>
                       </name>
                       <is_single_button><value>true</value></is_single_button>
                       <is_skip_confirmation><value>false</value></is_skip_confirmation>
                       <is_auto_close_result><value>true</value></is_auto_close_result> 
                       <is_direct><value>true</value></is_direct>
                       <is_object_obligatory><value>true</value></is_object_obligatory>
                       <param_window_width><value>400</value></param_window_width>
                       <param_window_height><value>200</value></param_window_height>
                       <icon>
                            <value>
                              <object code="/images/objectdefs/icons/color/128/graphics-notice.png" module="documents" objectdef="icon"></object>
                            </value>
                        </icon>
                       <execute>
                            <value>
                                <object code="most.protocol_sale.clear_stock:default_value:embedded_execution_script.execute" module="core" objectdef="vscript">
                                    <execution_timeout><value>7200</value></execution_timeout>
                                    <params>
                                        <value>
                                            <object code="objects" module="core" objectdef="script_param"></object>
                                        </value>
                                        <value>
                                            <object code="param" module="core" objectdef="script_param"></object>
                                        </value>
                                    </params>
                                    <script_code>
                                        <value><![CDATA[

if (objects == null) {
	return;
}
for (var s : objects) 
{
	s.stock.remove();
	s.official_date.remove();
	s.opg.remove();
	s.commit();
}
	
                                        ]]></value>
                                    </script_code>
                                </object>
                            </value>
                        </execute>
                        <is_show_multiple_relation><value>true</value></is_show_multiple_relation>
                        <is_show_single_relation><value>true</value></is_show_single_relation>
                    </object>
                </default_value>
            </clear_stock>				 
		</protocol_sale>

		<protocol_stock parent_objectdef="most.protocol">	

        	<sales>	
				<category>main.basic</category>
                <sort_id>8000</sort_id>
                <data_source>relation</data_source>
                <relation_parent>most.protocol_sale.stock</relation_parent>
			 	<is_multiple>true</is_multiple>
  				<name>
                    <en-US>Sales</en-US>
                </name>
                <name>
                    <de-DE>Verkäufe</de-DE>
                </name>
                <name>
                    <bg-BG>Продажби</bg-BG>
                </name>                                
        	</sales>

			<price_discount col="prd">
				<category>main.basic</category>
                <sort_id>100</sort_id>
			 	<data_source>input</data_source>
			 	<data_type>double</data_type>
				<min_value_double>0</min_value_double>			 	
				<name>
                    <en-US>Discount price</en-US>
                </name>
                <name>
                    <de-DE>Promopreis</de-DE>
                </name>
                <name>
                    <bg-BG>Цена с отстъпка</bg-BG>
                </name>      
                <on_update_value>
                    <object code="most.protocol:recalc_total" module="core" objectdef="vscript"/>                                          
                </on_update_value>
  				<on_insert_value>
                    <object code="most.protocol:recalc_total" module="core" objectdef="vscript"/>                       
                </on_insert_value> 
                <is_dynamic>true</is_dynamic>               
                <calculation>
                 	<object code="most.protocol_stock.price_discount:calculation_vsql" objectdef="calculation_vsql" module="core" >
						<select_value_statement><value>(CASE WHEN opg_entry.objectdef.code = 'opg_entry_percental' THEN (price * opg_entry.value / 100.0) ELSE opg_entry.value END)</value></select_value_statement>
					</object>
				</calculation>
			</price_discount>  	
			                 
			<used_quantity>
                 <category>main.basic</category>
                 <sort_id>4000</sort_id>
                 <is_inmaintbl>false</is_inmaintbl>
                 <is_multiple>false</is_multiple>
                 <data_source>input</data_source>
                 <data_type>integer</data_type>
                 <is_readonly>true</is_readonly>
                 <name>
                     <en-US>Used</en-US>
                 </name>
                 <name>
                     <de-DE>Verbraucht</de-DE>
                 </name>
                 <name>
                     <bg-BG>Използвани</bg-BG>
                 </name>
                 <is_dynamic>true</is_dynamic>
                 <calculation>
                 	<object code="most.protocol_stock.used_quantity:calculation_vsql" objectdef="calculation_vsql" module="core" >
						<select_value_statement><value><![CDATA[CAST ( COALESCE((SELECT SUM(sales.quantity) WHERE id = :VR__OUTER_SELECT_ID),0) + COALESCE((SELECT SUM(official_value) FROM most.state_adjustment_official WHERE stock = :VR__OUTER_SELECT_ID AND "date" < CURRENT_TIMESTAMP),0) AS INTEGER)]]></value></select_value_statement>
					</object>
				 </calculation>
             </used_quantity>             
             
             <rest_quantity>
                 <category>main.basic</category>
                 <sort_id>4001</sort_id>
                 <is_inmaintbl>false</is_inmaintbl>
                 <is_multiple>false</is_multiple>
                 <data_source>input</data_source>
                 <data_type>integer</data_type>
                 <is_readonly>true</is_readonly>
                 <name>
                     <en-US>Rest</en-US>
                 </name>
                 <name>
                     <de-DE>Rest</de-DE>
                 </name>
                 <name>
                     <bg-BG>Оставащи</bg-BG>
                 </name>
                 <is_dynamic>true</is_dynamic>
                 <calculation>
					<object code="most.protocol_stock.rest_quantity:calculation_vsql" objectdef="calculation_vsql" module="core" >
						<select_value_statement><value><![CDATA[CAST ((quantity - COALESCE((SELECT SUM(sales.quantity) WHERE id = :VR__OUTER_SELECT_ID),0) - COALESCE((SELECT SUM(official_value) FROM most.state_adjustment_official WHERE stock = :VR__OUTER_SELECT_ID AND "date" < CURRENT_TIMESTAMP),0)) AS INTEGER)]]></value></select_value_statement>
					</object>
				 </calculation>
             </rest_quantity>	
             			
			<!-- 
			<price_discount col="prd">
				<category>main.basic</category>
                <sort_id>100</sort_id>
			 	<data_source>input</data_source>
			 	<data_type>double</data_type>
				<min_value_double>0</min_value_double>			 	
                <is_inmaintbl>true</is_inmaintbl>
				<name>
                    <en-US>Discount price</en-US>
                </name>
                <name>
                    <de-DE>Promopreis</de-DE>
                </name>
                <name>
                    <bg-BG>Цена с отстъпка</bg-BG>
                </name>      
                <on_update_value>
                    <object code="most.protocol:recalc_total" module="core" objectdef="vscript"/>                                          
                </on_update_value>
  				<on_insert_value>
                    <object code="most.protocol:recalc_total" module="core" objectdef="vscript"/>                       
                </on_insert_value>                
			 </price_discount>  -->					 
			
			<opg is_keep_settings="true">
 				<relation_filter>
                     <object code="most.protocol_stock.opg" module="core" objectdef="relation_filter">
                        <get_related_objectdef_condition>
                            <value>
                                <object code="relation_filter:most.protocoL_stock.opg:get_related_objectdef_condition" module="core" objectdef="vscript">
                                    <params>
                                         <value>
                                            <object code="object" module="core" objectdef="script_param"></object>
                                        </value>
                                        <value>
                                            <object code="property" module="core" objectdef="script_param"></object>
                                        </value>
                                    </params>
                                    <script_code>
                                        <value><![CDATA[
if (object.article == null || object.official_date == null)
	return "0=1";
var rest = object.quantity;
var params = new M();
var sel = db.most.opg.SELECT("discount_mode.code IN ('U','M') AND (valid_from IS NULL OR valid_from <= :OFCD) AND (valid_to IS NULL OR valid_to >= :OFCD) AND entries.article.id = :PRID");
sel["OFCD"]=object.official_date.date;
sel["PRID"]=object.article.id;
var arr=[];
for (var e : sel.VALUE) 
{
	arr.push(e.id);
}
if (arr.is_empty)
	return "0=1";
return "id IN ("+arr.join(",")+")";	
                                    ]]></value>
                                    </script_code>
                                </object>
                            </value>
                        </get_related_objectdef_condition>
                   </object>
               </relation_filter> 
			</opg>
			
			<serial_ids>
				<data_type>varchar</data_type>
				<data_source>input</data_source>
                <category>main.settings</category>
                <sort_id>200</sort_id>
                <is_multiple>true</is_multiple>
				<value_table>$(DB_PREFIX)_m_var_srls</value_table>
  				<name>
                    <en-US>Serial IDs</en-US>
                </name>
                <name>
                    <de-DE>Seriennummern</de-DE>
                </name>
                <name>
                    <bg-BG>Серийни номера</bg-BG>
                </name>                
			</serial_ids>
			
			<invoice>
                <category>main.settings</category>
                <sort_id>160</sort_id>
                <is_inmaintbl>true</is_inmaintbl>
                <data_source>relation</data_source>
                <is_obligatory>false</is_obligatory>
                <related_objectdef>most.invoice</related_objectdef>
                <name>
                    <en-US>Invoice</en-US>
                </name>
                <name>
                    <de-DE>Rechnung</de-DE>
                </name>
                <name>
                    <bg-BG>Фактура</bg-BG>
                </name>
			</invoice>
							
        	<bundle_number>
				<category>main.basic</category>
                <sort_id>140</sort_id>
                <data_source>input</data_source>
                <data_type>varchar</data_type>
                <is_inmaintbl>true</is_inmaintbl>
  				<name>
                    <en-US>Bundle number</en-US>
                </name>
                <name>
                    <de-DE>Bündelnummer</de-DE>
                </name>
                <name>
                    <bg-BG>Вързоп номер</bg-BG>     
                </name>   	
        	</bundle_number>  
        
            <sync_edi>
                <category>main.basic</category>
                <sort_id>100002</sort_id>
                <data_source>relation</data_source>
                <related_objectdef>core.embedded_execution_script</related_objectdef>
                <is_constant>true</is_constant>
                <is_hidden>true</is_hidden>
                <display_type>property.relation.script_execution</display_type>
                <name><en-US>Sync with EDI</en-US></name>
                <name><de-DE>Mit EDI synchronizieren</de-DE></name>
                <name><bg-BG>Синхронизирай с EDI</bg-BG></name>
                <default_value>
                    <object code="most.protocol_stock.sync_edi:default_value:embedded_execution_script" objectdef="embedded_execution_script" module="core">
                       <name>
                            <value>
                                <en-US>Sync with EDI!</en-US>
                            </value>
                            <value>
                                <de-DE>Mit EDI synchronizieren!</de-DE>
                            </value>
                            <value>
                                <bg-BG>Синхронизирай с EDI!</bg-BG>
                            </value>
                       </name>
                       <is_single_button><value>true</value></is_single_button>
                       <is_skip_confirmation><value>false</value></is_skip_confirmation>
                       <is_auto_close_result><value>true</value></is_auto_close_result> 
                       <is_direct><value>true</value></is_direct>
                       <is_object_obligatory><value>true</value></is_object_obligatory>
                       <param_window_width><value>400</value></param_window_width>
                       <param_window_height><value>200</value></param_window_height>
                       <icon>
                            <value>
                              <object code="/images/objectdefs/icons/color/128/all-history.png" module="documents" objectdef="icon"></object>
                            </value>
                        </icon>
                       <execute>
                            <value>
                                <object code="most.protocol_stock.sync_edi:default_value:embedded_execution_script.execute" module="core" objectdef="vscript">
                                    <execution_timeout><value>7200</value></execution_timeout>
                                    <params>
                                        <value>
                                            <object code="objects" module="core" objectdef="script_param"></object>
                                        </value>
                                        <value>
                                            <object code="param" module="core" objectdef="script_param"></object>
                                        </value>
                                    </params>
                                    <script_code>
                                        <value><![CDATA[
writeln("<h1>Get stock...</h1>");                                        
writeln(STR2HTML(system.vsp_to_string("<%vsp:include script=\"${web.lib.dir}/most/getstock.vr\" />")));
writeln("<br/><h1>Get OPG...</h1>");                                        
writeln(STR2HTML(system.vsp_to_string("<%vsp:include script=\"${web.lib.dir}/most/getopg.vr\" />")));                                        
                                        ]]></value>
                                    </script_code>
                                </object>
                            </value>
                        </execute>
                        <is_show_multiple_relation><value>true</value></is_show_multiple_relation>
                        <is_show_single_relation><value>true</value></is_show_single_relation>
                    </object>
                </default_value>
            </sync_edi>				 


            <assign_official_date>
                <category>main.basic</category>
                <sort_id>100002</sort_id>
                <data_source>relation</data_source>
                <related_objectdef>core.embedded_execution_script</related_objectdef>
                <is_constant>true</is_constant>
                <is_hidden>false</is_hidden>
                <display_type>property.relation.script_execution</display_type>
                <name><en-US>Auto official date</en-US></name>
                <name><de-DE>Belieferungsdatum automatisch zuweisen</de-DE></name>
                <name><bg-BG>Автоматично осчетоводяване</bg-BG></name>
                <default_value>
                    <object code="most.protocol_stock.assign_official_date:default_value:embedded_execution_script" objectdef="embedded_execution_script" module="core">
                       <name>
                            <value>
                                <en-US>Auto official date!</en-US>
                            </value>
                            <value>
                                <de-DE>Belieferungsdatum automatisch zuweisen!</de-DE>
                            </value>
                            <value>
                                <bg-BG>Автоматично осчетоводяване!</bg-BG>
                            </value>
                       </name>
                       <is_single_button><value>true</value></is_single_button>
                       <is_skip_confirmation><value>false</value></is_skip_confirmation>
                       <is_auto_close_result><value>false</value></is_auto_close_result> 
                       <is_direct><value>true</value></is_direct>
                       <is_object_obligatory><value>true</value></is_object_obligatory>
                       <param_window_width><value>400</value></param_window_width>
                       <param_window_height><value>200</value></param_window_height>
                       <icon>
                            <value>
                              <object code="/images/objectdefs/icons/color/128/accounting-accounting_month.png" module="documents" objectdef="icon"></object>
                            </value>
                        </icon>
                        <param_objectdef>
                            <value>
                                <object code="script_execution_context_daily_report_param" cond="module.code='most'" objectdef="objectdef" module="core" mode="update"/>
                            </value>
                        </param_objectdef>                   
                       <execute>
                            <value>
                                <object code="most.protocol_stock.assign_official_date:default_value:embedded_execution_script.execute" module="core" objectdef="vscript">
                                    <execution_timeout><value>7200</value></execution_timeout>
                                    <params>
                                        <value>
                                            <object code="objects" module="core" objectdef="script_param"></object>
                                        </value>
                                        <value>
                                            <object code="param" module="core" objectdef="script_param"></object>
                                        </value>
                                    </params>
                                    <script_code>
                                        <value><![CDATA[

if (objects == null) {
	return;
}
for (var e : objects) if (e.official_date == null) {
	e.official_date=param.date;
	e.commit();
}
                                        ]]></value>
                                    </script_code>
                                </object>
                            </value>
                        </execute>
                        <is_show_multiple_relation><value>true</value></is_show_multiple_relation>
                        <is_show_single_relation><value>true</value></is_show_single_relation>
                    </object>
                </default_value>
            </assign_official_date>	            
            
            <clear_official_date>
                <category>main.basic</category>
                <sort_id>100002</sort_id>
                <data_source>relation</data_source>
                <related_objectdef>core.embedded_execution_script</related_objectdef>
                <is_constant>true</is_constant>
                <is_hidden>false</is_hidden>
                <display_type>property.relation.script_execution</display_type>
                <name><en-US>Clear official date</en-US></name>
                <name><de-DE>Offizieles Belieferungdatum entfernen</de-DE></name>
                <name><bg-BG>Премахни осчетоводяване</bg-BG></name>
                <default_value>
                    <object code="most.protocol_stock.clear_official_date:default_value:embedded_execution_script" objectdef="embedded_execution_script" module="core">
                       <name>
                            <value>
                                <en-US>Clear official date!</en-US>
                            </value>
                            <value>
                                <de-DE>Offizieles Belieferungdatum entfernen!</de-DE>
                            </value>
                            <value>
                                <bg-BG>Премахни осчетоводяване!</bg-BG>
                            </value>
                       </name>
                       <is_single_button><value>true</value></is_single_button>
                       <is_skip_confirmation><value>false</value></is_skip_confirmation>
                       <is_auto_close_result><value>true</value></is_auto_close_result> 
                       <is_direct><value>true</value></is_direct>
                       <is_object_obligatory><value>true</value></is_object_obligatory>
                       <param_window_width><value>400</value></param_window_width>
                       <param_window_height><value>200</value></param_window_height>
                       <icon>
                            <value>
                              <object code="/images/objectdefs/icons/color/128/graphics-notice.png" module="documents" objectdef="icon"></object>
                            </value>
                        </icon>
                       <execute>
                            <value>
                                <object code="most.protocol_stock.clear_official_date:default_value:embedded_execution_script.execute" module="core" objectdef="vscript">
                                    <execution_timeout><value>7200</value></execution_timeout>
                                    <params>
                                        <value>
                                            <object code="objects" module="core" objectdef="script_param"></object>
                                        </value>
                                        <value>
                                            <object code="param" module="core" objectdef="script_param"></object>
                                        </value>
                                    </params>
                                    <script_code>
                                        <value><![CDATA[

if (objects == null) {
	return;
}
for (var s : objects) 
{
	s.official_date.remove();
	s.commit();
}
	
                                        ]]></value>
                                    </script_code>
                                </object>
                            </value>
                        </execute>
                        <is_show_multiple_relation><value>true</value></is_show_multiple_relation>
                        <is_show_single_relation><value>true</value></is_show_single_relation>
                    </object>
                </default_value>
            </clear_official_date>				

		</protocol_stock>


		<protocol_date tbl="ptd" copy_from="core.template_normal_transaction" is_abstract="true">

			  <code is_keep_settings="true">
				<is_unique>true</is_unique>
	 		  </code>
			  <objectdef is_keep_settings="true">
				<is_hidden>true</is_hidden>
	 		  </objectdef>

			  <protocols mode="delete"></protocols>
     		  <total_in mode="delete"/>
      		  <total_out mode="delete"/>
      		  <stocks mode="delete"/>
      		  <total_stock_offical mode="delete"/>
      		  <total_sales_offical mode="delete"/>
     		  
     		  <stock_real>
                 <category>most.protocol_date.real.stock</category>
                 <sort_id>1000</sort_id>
                 <is_inmaintbl>false</is_inmaintbl>
                 <is_multiple>true</is_multiple>
                 <data_source>relation</data_source>
                 <related_objectdef>most.protocol</related_objectdef>
                 <is_readonly>true</is_readonly>
                 <name>
                     <en-US>Real stock</en-US>
                 </name>
                 <name>
                     <de-DE>Reale Belieferung</de-DE>
                 </name>
                 <name>
                     <bg-BG>Реално зарежданe</bg-BG>
                 </name>
                 <is_dynamic>true</is_dynamic>
                 <calculation>
                     <object code="most.protocol_date.stock_real:calculation_relation_path" module="core" objectdef="calculation_relation_path">
                         <property_code_path>
                             <value>real_protocols</value>
                         </property_code_path>
                         <where_statement>
                             <value>real_protocols.objectdef.code = 'protocol_stock'</value>
                         </where_statement>
                     </object>
                 </calculation>
             </stock_real>
             
             <stock_official>
                 <category>most.protocol_date.official.stock</category>
                 <sort_id>1001</sort_id>
                 <is_inmaintbl>false</is_inmaintbl>
                 <is_multiple>true</is_multiple>
                 <data_source>relation</data_source>
                 <related_objectdef>most.protocol</related_objectdef>
                 <name>
                     <en-US>Official stock</en-US>
                 </name>
                 <name>
                     <de-DE>Offiziele Belieferung</de-DE>
                 </name>
                 <name>
                     <bg-BG>Официално зарежданe</bg-BG>
                 </name>
                 <is_dynamic>true</is_dynamic>
                 <calculation>
                     <object code="most.protocol_date.stock_official:calculation_relation_path" module="core" objectdef="calculation_relation_path">
                         <property_code_path>
                             <value>official_protocols</value>
                         </property_code_path>
                         <where_statement>
                             <value>official_protocols.objectdef.code = 'protocol_stock'</value>
                         </where_statement>
                     </object>
                 </calculation>
             </stock_official>
              
     		 <total_stock_real>
                 <category>most.protocol_date.real.stock</category>
                 <sort_id>1002</sort_id>
                 <is_inmaintbl>false</is_inmaintbl>
                 <is_multiple>false</is_multiple>
                 <data_source>input</data_source>
                 <data_type>double</data_type>
                 <is_readonly>true</is_readonly>
                 <name>
                     <en-US>Real stock total</en-US>
                 </name>
                 <name>
                     <de-DE>Reale Belieferung Total</de-DE>
                 </name>
                 <name>
                     <bg-BG>Реално зареждане общо</bg-BG>
                 </name>
                 <is_dynamic>true</is_dynamic>
                 <calculation>
                     <object code="most.protocol_date.total_stock_real:sum_calculation_relation_path" module="core" objectdef="calculation_relation_path_sum">
                         <property_code_path>
                             <value>real_protocols.total</value>
                         </property_code_path>
                         <where_statement>
                             <value>real_protocols.objectdef.code = 'protocol_stock'</value>
                         </where_statement>
                     </object>
                 </calculation>
             </total_stock_real>
             
             <total_stock_official>
                 <category>most.protocol_date.official.stock</category>
                 <sort_id>1003</sort_id>
                 <is_inmaintbl>false</is_inmaintbl>
                 <is_multiple>false</is_multiple>
                 <data_source>input</data_source>
                 <data_type>double</data_type>
                 <is_readonly>true</is_readonly>
                 <name>
                     <en-US>Official stock total</en-US>
                 </name>
                 <name>
                     <de-DE>Offizielle Belieferung Total</de-DE>
                 </name>
                 <name>
                     <bg-BG>Официално зареждане общо</bg-BG>
                 </name>
                 <is_dynamic>true</is_dynamic>
                 <calculation>
                     <object code="most.protocol_date.total_stock_official:sum_calculation_relation_path" module="core" objectdef="calculation_relation_path_sum">
                         <property_code_path>
                             <value>official_protocols.total</value>
                         </property_code_path>
                         <where_statement>
                             <value>official_protocols.objectdef.code = 'protocol_stock'</value>
                         </where_statement>
                     </object>
                 </calculation>
             </total_stock_official>           
            
             <sales_real>
                 <category>most.protocol_date.real.sale</category>
                 <sort_id>1004</sort_id>
                 <is_inmaintbl>false</is_inmaintbl>
                 <is_multiple>true</is_multiple>
                 <data_source>relation</data_source>
                 <related_objectdef>most.protocol</related_objectdef>
                 <is_readonly>true</is_readonly>
                 <name>
                     <en-US>Real sales</en-US>
                 </name>
                 <name>
                     <de-DE>Reale Verkäufe</de-DE>
                 </name>
                 <name>
                     <bg-BG>Реални продажби</bg-BG>
                 </name>
                 <is_dynamic>true</is_dynamic>
                 <calculation>
                     <object code="most.protocol_date.sales_real:calculation_relation_path" module="core" objectdef="calculation_relation_path">
                         <property_code_path>
                             <value>real_protocols</value>
                         </property_code_path>
                         <where_statement>
                             <value>real_protocols.objectdef.code = 'protocol_sale'</value>
                         </where_statement>
                     </object>
                 </calculation>
             </sales_real>
             
             <sales_official>
                 <category>most.protocol_date.official.sale</category>
                 <sort_id>1005</sort_id>
                 <is_inmaintbl>false</is_inmaintbl>
                 <is_multiple>true</is_multiple>
                 <data_source>relation</data_source>
                 <related_objectdef>most.protocol</related_objectdef>
                 <is_readonly>true</is_readonly>
                 <name>
                     <en-US>Official sales</en-US>
                 </name>
                 <name>
                     <de-DE>Offiziele Verkäufe</de-DE>
                 </name>
                 <name>
                     <bg-BG>Официални продажби</bg-BG>
                 </name>
                 <is_dynamic>true</is_dynamic>
                 <calculation>
                     <object code="most.protocol_date.sales_official:calculation_relation_path" module="core" objectdef="calculation_relation_path">
                         <property_code_path>
                             <value>official_protocols</value>
                         </property_code_path>
                         <where_statement>
                             <value>official_protocols.objectdef.code = 'protocol_sale'</value>
                         </where_statement>
                     </object>
                 </calculation>
             </sales_official> 
             
             <total_sales_real>
                 <category>most.protocol_date.real.sale</category>
                 <sort_id>1006</sort_id>
                 <is_inmaintbl>false</is_inmaintbl>
                 <is_multiple>false</is_multiple>
                 <data_source>input</data_source>
                 <data_type>double</data_type>
                 <is_readonly>true</is_readonly>
                 <name>
                     <en-US>Sales real total</en-US>
                 </name>
                 <name>
                     <de-DE>Reale Verkäufe Total</de-DE>
                 </name>
                 <name>
                     <bg-BG>Реални продажби общо</bg-BG>
                 </name>
                 <is_dynamic>true</is_dynamic>
                 <calculation>
                     <object code="most.protocol_date.total_sales_real:sum_calculation_relation_path" module="core" objectdef="calculation_relation_path_sum">
                         <property_code_path>
                             <value>real_protocols.total</value>
                         </property_code_path>
                         <where_statement>
                             <value>real_protocols.objectdef.code = 'protocol_sale'</value>
                         </where_statement>
                     </object>
                 </calculation>
             </total_sales_real>
             
             <total_sales_official>
                 <category>most.protocol_date.official.sale</category>
                 <sort_id>1007</sort_id>
                 <is_inmaintbl>false</is_inmaintbl>
                 <is_multiple>false</is_multiple>
                 <data_source>input</data_source>
                 <data_type>double</data_type>
                 <is_readonly>true</is_readonly>
                 <name>
                     <en-US>Official sales total</en-US>
                 </name>
                 <name>
                     <de-DE>Offizielle Verkäufe Total</de-DE>
                 </name>
                 <name>
                     <bg-BG>Официални продажби общо</bg-BG>
                 </name>
                 <is_dynamic>true</is_dynamic>
                 <calculation>
                     <object code="most.protocol_date.sales_official:sum_calculation_relation_path" module="core" objectdef="calculation_relation_path_sum">
                         <property_code_path>
                             <value>official_protocols.total</value>
                         </property_code_path>
                         <where_statement>
                             <value>official_protocols.objectdef.code = 'protocol_sale'</value>
                         </where_statement>
                     </object>
                 </calculation>
             </total_sales_official>
             
     		 <official_protocols>
                <category>main.basic</category>
                <data_source>relation</data_source>
                <relation_parent>most.protocol.official_date</relation_parent>
                <name>
                    <en-US>Official protocols</en-US>
                </name>
                <name>
                    <de-DE>Offiziele Protokolle</de-DE>
                </name>
                <name>
                    <bg-BG>Официални протоколи</bg-BG>
                </name>
				<display_type>property.relation.multiple.add.new</display_type>
				<relation_filter>core_property_default_relation_filter_simple_bidirectional_relation</relation_filter>
				<is_hidden>true</is_hidden>
				<sort_id>500</sort_id>
             </official_protocols>
             
             <real_protocols>
                <category>main.basic</category>
                <data_source>relation</data_source>
                <relation_parent>most.protocol.real_date</relation_parent>
                <name>
                    <en-US>Real protocols</en-US>
                </name>
                <name>
                    <de-DE>Reale Protokolle</de-DE>
                </name>
                <name>
                    <bg-BG>Реални протоколи</bg-BG>
                </name>
				<display_type>property.relation.multiple.add.new</display_type>
				<relation_filter>core_property_default_relation_filter_simple_bidirectional_relation</relation_filter>
				<is_hidden>true</is_hidden>
				<sort_id>501</sort_id>
             </real_protocols>

     		 <date>
                <category>main.basic</category>
                <sort_id>150</sort_id>
                <is_inmaintbl>true</is_inmaintbl>
                <data_source>input</data_source>
                <data_type>datetime</data_type>
                <name>
                    <en-US>Date</en-US>
                </name>
                <name>
                    <de-DE>Datum</de-DE>
                </name>
                <name>
                    <bg-BG>Дата</bg-BG>
                </name>
                <input_format>default_input_format_date</input_format>
                <output_format>default_output_format_date</output_format>
                <is_obligatory>true</is_obligatory>
                <default_value_calculation>
                    <object code="most.proctol.date:default_value_calculation" module="core" objectdef="vscript">
                        <params>
                            <value>
                                <object code="id" module="core" objectdef="script_param" proj="all"></object>
                            </value>
                        </params>
                        <script_code>
                            <value><![CDATA[return java.date.now(); /* TODO!!! */ ]]></value>
                        </script_code>
                    </object>
                </default_value_calculation>
                <index_code>d</index_code>
             </date>
             
             <is_active>
             	<category>main.settings</category>
                <sort_id>151</sort_id>
                <is_inmaintbl>true</is_inmaintbl>
                <is_obligatory>true</is_obligatory>
                <data_source>option</data_source>
                <option_set>boolean</option_set>
                <name>
                    <en-US>Active?</en-US>
                </name>
                <name>
                    <de-DE>Aktiv?</de-DE>
                </name>
                <name>
                    <bg-BG>Активна?</bg-BG>
                </name>	
                <default_value>false</default_value>
                <on_update_value>
                    <object code="most.protocol_date.is_active:on_change" module="core" objectdef="vscript">                       
                        <script_code>
                            <value><![CDATA[
if (this.is_active) 
{
	for (var e : db.most.protocol_date.selectWhere("is_active = 1 AND id <> "+this.id)) {
		e.is_active=false;
	}
}
                        ]]></value>
                        </script_code>
                    </object>
                </on_update_value>
             </is_active>		             
             
            <is_show>
             	<category>main.settings</category>
                <sort_id>152</sort_id>
                <is_inmaintbl>true</is_inmaintbl>
                <is_obligatory>true</is_obligatory>
                <data_source>option</data_source>
                <option_set>boolean</option_set>
                <name>
                    <en-US>Show?</en-US>
                </name>
                <name>
                    <de-DE>Anzeige?</de-DE>
                </name>
                <name>
                    <bg-BG>Показане?</bg-BG>
                </name>	
                <default_value>false</default_value>              
             </is_show>		

			 <category mode="delete"/>

             <month>
                 <category>main.basic</category>
                 <sort_id>6000</sort_id>
                 <is_inmaintbl>true</is_inmaintbl>
                 <data_source>relation</data_source>
                 <related_objectdef>most.protocol_month</related_objectdef>
                 <name>
                     <en-US>Month</en-US>
                 </name>
                 <name>
                     <de-DE>Monat</de-DE>
                 </name>
                 <name>
                     <bg-BG>Месец</bg-BG>
                 </name>
                 <index_code>mn</index_code>
                 <is_obligatory>true</is_obligatory>                     
             </month>

		</protocol_date>
		
		<protocol_month copy_from="core.template_normal_transaction" is_abstract="false" tbl="mnt">
 			 
 			 <quarter>
                 <category>main.basic</category>
                 <sort_id>6000</sort_id>
                 <is_inmaintbl>true</is_inmaintbl>
                 <data_source>relation</data_source>
                 <related_objectdef>most.protocol_quarter</related_objectdef>
                 <name>
                     <en-US>Quarter</en-US>
                 </name>
                 <name>
                     <de-DE>Quartal</de-DE>
                 </name>
                 <name>
                     <bg-BG>Тримесечие</bg-BG>
                 </name>
                 <index_code>qr</index_code>
                 <is_obligatory>true</is_obligatory>                     
             </quarter>	
             
        	 <dates>
                 <category>main.basic</category>
                 <sort_id>7000</sort_id>
                 <is_inmaintbl>true</is_inmaintbl>
                 <data_source>relation</data_source>
                 <relation_parent>most.protocol_date.month</relation_parent>
                 <name>
                     <en-US>Dates</en-US>
                 </name>
                 <name>
                     <de-DE>Daten</de-DE>
                 </name>
                 <name>
                     <bg-BG>Дати</bg-BG>
                 </name>
                 <is_readonly>true</is_readonly>
             </dates>
             
	 		 <product_lines mode="delete"/>
             <product_groups mode="delete"/>                                       
             
	 	</protocol_month>
	 	
		<invoice copy_from="core.template_normal_transaction" is_abstract="true" tbl="inv">
			
			<company mode="delete"/>

			<code is_keep_settings="true">
				<is_unique>true</is_unique>
			</code>
			
			<contract>
				<category>main.basic</category>
                <sort_id>110</sort_id>
                <data_source>input</data_source>
                <data_type>varchar</data_type>
                <is_inmaintbl>true</is_inmaintbl>
  				<name>
                    <en-US>Contract</en-US>
                </name>
                <name>
                    <de-DE>Vertrag</de-DE>
                </name>
                <name>
                    <bg-BG>Договор</bg-BG>
                </name>                
			</contract>
			
			<vendor>
				<data_source>relation</data_source>
   				<category>main.basic</category>
                <sort_id>120</sort_id>
                <data_source>relation</data_source>
                <related_objectdef>contacts.vendor</related_objectdef>
                <name>
                    <en-US>Vendor</en-US>
                </name>
                <name>
                    <de-DE>Hersteller</de-DE>
                </name>
                <name>
                    <bg-BG>Производител</bg-BG>
                </name>
                <is_hidden>false</is_hidden>
                <is_obligatory>true</is_obligatory>
                <is_inmaintbl>true</is_inmaintbl>
                <display_type mode="delete"/>
           </vendor>
			
           <invoice_date>
               <category>main.basic</category>
               <sort_id>130</sort_id>
               <is_inmaintbl>true</is_inmaintbl>
               <data_type>datetime</data_type>
               <name>
                   <en-US>Date invoice</en-US>
               </name>
               <name>
                   <de-DE>Rechnungsdatum</de-DE>
               </name>
               <name>
                   <bg-BG>Дата Фактура</bg-BG>
               </name>
               <is_obligatory>true</is_obligatory>
               <input_format>default_input_format_date</input_format>
               <output_format>default_output_format_date</output_format>
			</invoice_date>
			
			<purchase_order>
				<category>main.basic</category>
                <sort_id>140</sort_id>
                <data_source>input</data_source>
                <data_type>varchar</data_type>
                <is_inmaintbl>true</is_inmaintbl>
  				<name>
                    <en-US>Purchase order</en-US>
                </name>
                <name>
                    <de-DE>Auftrag</de-DE>
                </name>
                <name>
                    <bg-BG>Заявка</bg-BG>
                </name>                
			</purchase_order>
			

			<import_time>
                <category>main.basic</category>
                <sort_id>9000</sort_id>
                <is_inmaintbl>true</is_inmaintbl>
                <data_source>input</data_source>
                <data_type>datetime</data_type>
                <name>
                    <en-US>Import time</en-US>
                </name>
                <name>
                    <de-DE>Importzeit</de-DE>
                </name>
                <name>
                    <bg-BG>Момент на импорт</bg-BG>
                </name>
                <is_hidden>false</is_hidden>
                <is_system>false</is_system>
                <is_readonly>true</is_readonly>
                <index_code>itm</index_code>
            </import_time>

			<total>
				<category>main.basic</category>
                <sort_id>102</sort_id>
                <data_source>input</data_source>
                <data_type>double</data_type>
                <is_inmaintbl>true</is_inmaintbl>
  				<name>
                    <en-US>Total</en-US>
                </name>
                <name>
                    <de-DE>Total</de-DE>
                </name>
                <name>
                    <bg-BG>Общо</bg-BG>
                </name> 
			 </total>

			<stocks mode="delete"/>			
        </invoice>
        
		<invoice_stock parent_objectdef="most.invoice">
			
			<stocks>
                <category>main.basic</category>
                <sort_id>160</sort_id>
                <data_source>relation</data_source>
                <relation_parent>most.protocol_stock.invoice</relation_parent>
                <name>
                    <en-US>Stocks</en-US>
                </name>
                <name>
                    <de-DE>Belieferungen</de-DE>
                </name>
                <name>
                    <bg-BG>Зареждания</bg-BG>
                </name>
			</stocks>
		</invoice_stock>

		<credit_note parent_objectdef="most.invoice">

			 <quarter>
			 	<category>main.basic</category>
			 	<sort_id>4000</sort_id>
			 	<data_source>relation</data_source>
			 	<related_objectdef>most.protocol_quarter</related_objectdef>
			 	<is_obligatory>true</is_obligatory>
			 	<is_inmaintbl>true</is_inmaintbl>
			 	<index_code>qr</index_code>
                <name>
                     <en-US>Quarter</en-US>
                </name>
                <name>
                     <de-DE>Quartal</de-DE>
                 </name>
                <name>
                     <bg-BG>Тримесечие</bg-BG>
                </name>
                <default_value_calculation>
                    <object code="most.credit_note.quarter:default_value_calculation" module="core" objectdef="vscript">
                        <params>
                            <value>
                                <object code="id" module="core" objectdef="script_param" proj="all"></object>
                            </value>
                        </params>
                        <script_code>
                            <value><![CDATA[
var month = java.date.now().month;
var q=0;
if (month >= 0 && month <= 2) 
	q=1;
else if (month >= 0+3 && month <= 2+3) 
	q=2;
else if (month >= 0+6 && month <= 2+6) 
	q=3;
else if (month >= 0+9 && month <= 2+9) 
	q=4;
var key = "Q"+q+" "+java.date.now().year;
return db.most.protocol_quarter.INSTANCES[key];
                            ]]></value>
                        </script_code>
                    </object>
                </default_value_calculation>
			 </quarter>				

		</credit_note>


		<protocol_quarter copy_from="core.template_normal_transaction" is_abstract="false" tbl="qrt">
	 		 
	 		 <objectdef is_keep_settings="true">
	 		 	<is_hidden>true</is_hidden>
	 		 </objectdef>

	 		 <code is_keep_settings="true">
				<is_unique>true</is_unique>
			 </code>
			 			 
        	 <year>
                 <category>main.basic</category>
                 <sort_id>6000</sort_id>
                 <is_inmaintbl>true</is_inmaintbl>
                 <data_source>relation</data_source>
                 <related_objectdef>most.protocol_year</related_objectdef>
                 <name>
                     <en-US>Year</en-US>
                 </name>
                 <name>
                     <de-DE>Jahr</de-DE>
                 </name>
                 <name>
                     <bg-BG>Година</bg-BG>
                 </name>
                 <index_code>pq</index_code>
                 <is_obligatory>true</is_obligatory>                     
             </year>
              			 
        	 <months>
                 <category>main.basic</category>
                 <sort_id>7000</sort_id>
                 <data_source>relation</data_source>
                 <relation_parent>most.protocol_month.quarter</relation_parent>
                 <name>
                     <en-US>Months</en-US>
                 </name>
                 <name>
                     <de-DE>Monate</de-DE>
                 </name>
                 <name>
                     <bg-BG>Месеци</bg-BG>
                 </name>
                 <is_readonly>true</is_readonly>
             </months>
             
                          
	 		<dates>
                <category>main.basic</category>
                <sort_id>9001</sort_id>
                <data_source>relation</data_source>
                <is_multiple>true</is_multiple>
                <is_readonly>false</is_readonly>
                <related_objectdef>most.protocol_date</related_objectdef>
                <is_dynamic>true</is_dynamic>
                <name>
                    <en-US>Dates</en-US>
                    <de-DE>Daten</de-DE>
                    <bg-BG>Дати</bg-BG>
                </name>
             	<is_dynamic>true</is_dynamic>               
                <calculation>
	     			<object code="most.protocol_quarter.dates:calculation_relation_path" module="core" objectdef="calculation_relation_path">
                         <property_code_path>
                             <value>months.dates</value>
                         </property_code_path>
                     </object>
                 </calculation>
             </dates>       
             
        	 <credit_notes>
                 <category>main.basic</category>
                 <sort_id>10000</sort_id>
                 <is_inmaintbl>true</is_inmaintbl>
                 <data_source>relation</data_source>
                 <relation_parent>most.credit_note.quarter</relation_parent>
                 <name>
                     <en-US>Credit notes</en-US>
                 </name>
                 <name>
                     <de-DE>Kreditnoten</de-DE>
                 </name>
                 <name>
                     <bg-BG>Кредитни известия</bg-BG>
                 </name>
                 <is_readonly>true</is_readonly>
             </credit_notes>      
             
	 		 <product_lines mode="delete"/>
             <product_groups mode="delete"/>  
                     
        </protocol_quarter>
        
        <protocol_year copy_from="core.template_normal_transaction" is_abstract="false" tbl="yr">
	 		 
	 		 <objectdef is_keep_settings="true">
	 		 	<is_hidden>true</is_hidden>
	 		 </objectdef>

	 		 <code is_keep_settings="true">
				<is_unique>true</is_unique>
			 </code>
			 			 
        	 <quarters>
                 <category>main.basic</category>
                 <sort_id>7000</sort_id>
                 <data_source>relation</data_source>
                 <relation_parent>most.protocol_quarter.year</relation_parent>
                 <name>
                     <en-US>Quarters</en-US>
                 </name>
                 <name>
                     <de-DE>Quartale</de-DE>
                 </name>
                 <name>
                     <bg-BG>Тримесечия</bg-BG>
                 </name>
                 <is_readonly>true</is_readonly>
             </quarters>

 			<months>
                <category>main.basic</category>
                <sort_id>9000</sort_id>
                <data_source>relation</data_source>
                <is_multiple>true</is_multiple>
                <is_readonly>false</is_readonly>
                <related_objectdef>most.protocol_month</related_objectdef>
                <is_dynamic>true</is_dynamic>
                <name>
                    <en-US>Months</en-US>
                    <de-DE>Monate</de-DE>
                    <bg-BG>Месеци</bg-BG>
                </name>
             	<is_dynamic>true</is_dynamic>               
                <calculation>
	     			<object code="most.protocol_year.months:calculation_relation_path" module="core" objectdef="calculation_relation_path">
                         <property_code_path>
                             <value>quarters.months</value>
                         </property_code_path>
                     </object>
                 </calculation>
             </months>           
             
			 <dates>
                <category>main.basic</category>
                <sort_id>9001</sort_id>
                <data_source>relation</data_source>
                <is_multiple>true</is_multiple>
                <is_readonly>false</is_readonly>
                <related_objectdef>most.protocol_date</related_objectdef>
                <is_dynamic>true</is_dynamic>
                <name>
                    <en-US>Dates</en-US>
                    <de-DE>Daten</de-DE>
                    <bg-BG>Дати</bg-BG>
                </name>
             	<is_dynamic>true</is_dynamic>               
                <calculation>
	     			<object code="most.protocol_year.dates:calculation_relation_path" module="core" objectdef="calculation_relation_path">
                         <property_code_path>
                             <value>quarters.months.dates</value>
                         </property_code_path>
                     </object>
                 </calculation>
             </dates>               
                          
        </protocol_year>        	

        
        
        <opg_entry tbl="ope" copy_from="core.template_normal_transaction" is_abstract="true">
			
			<code is_keep_settings="true">
				<is_unique>true</is_unique>
			</code>
			
			<expires_on mode="delete"/>
			
			<article>
				<category>main.basic</category>
                <sort_id>101</sort_id>
                <data_source>relation</data_source>
			 	<related_objectdef>most.article</related_objectdef>
			 	<is_obligatory>true</is_obligatory>			 	
                <is_inmaintbl>true</is_inmaintbl>
                <index_code>a</index_code>
  				<name>
                    <en-US>Article</en-US>
                </name>
                <name>
                    <de-DE>Artikel</de-DE>
                </name>
                <name>
                    <bg-BG>Артикул</bg-BG>
                </name>                
			</article>
			
			<value>	
				<category>main.basic</category>
                <sort_id>110</sort_id>
                <data_source>input</data_source>
                <data_type>double</data_type>
                <min_value_double>0</min_value_double>
			 	<is_obligatory>true</is_obligatory>			 	
                <is_inmaintbl>true</is_inmaintbl>
                <default_value>0</default_value>
  				<name>
                    <en-US>Value</en-US>
                </name>
                <name>
                    <de-DE>Wert</de-DE>
                </name>
                <name>
                    <bg-BG>Стойност</bg-BG>
                </name>                
			</value>	
	
			<max_quantity col="maxc">	
				<category>main.basic</category>
                <sort_id>111</sort_id>
                <data_source>input</data_source>
                <data_type>integer</data_type>
                <min_value_integer>1</min_value_integer>
                <is_inmaintbl>true</is_inmaintbl>
  				<name>
                    <en-US>Max quantity</en-US>
                </name>
                <name>
                    <de-DE>Maximale Quantität</de-DE>
                </name>
                <name>
                    <bg-BG>Максимално количество</bg-BG>
                </name>                
			</max_quantity>	
					
			<opg>
                <category>main.basic</category>
                <sort_id>2000</sort_id>
                <is_inmaintbl>true</is_inmaintbl>
                <is_readonly>true</is_readonly>
                <is_obligatory>true</is_obligatory>
                <data_source>relation</data_source>
                <related_objectdef>most.opg</related_objectdef>
                <name>
                    <en-US>OPG</en-US>
                </name>
                <index_code>og</index_code>
			</opg>

			<used_quantity>
                 <category>main.basic</category>
                 <sort_id>4000</sort_id>
                 <is_inmaintbl>false</is_inmaintbl>
                 <is_multiple>false</is_multiple>
                 <data_source>input</data_source>
                 <data_type>integer</data_type>
                 <is_readonly>true</is_readonly>
                 <name>
                     <en-US>Used</en-US>
                 </name>
                 <name>
                     <de-DE>Verbraucht</de-DE>
                 </name>
                 <name>
                     <bg-BG>Използвани</bg-BG>
                 </name>
                 <is_dynamic>true</is_dynamic>
                 <calculation>
                 	<object code="most.opg_entry.used_quantity:calculation_vsql" objectdef="calculation_vsql" module="core" >
						<select_value_statement><value>CAST (COALESCE((SELECT SUM(protocols.quantity) WHERE id = :VR__OUTER_SELECT_ID AND protocols.objectdef.code='protocol_sale'),0) AS INTEGER)</value></select_value_statement>
					</object>
				 </calculation>
             </used_quantity>	
             
             <rest_quantity>
                 <category>main.basic</category>
                 <sort_id>4001</sort_id>
                 <is_inmaintbl>false</is_inmaintbl>
                 <is_multiple>false</is_multiple>
                 <data_source>input</data_source>
                 <data_type>integer</data_type>
                 <is_readonly>true</is_readonly>
                 <name>
                     <en-US>Rest</en-US>
                 </name>
                 <name>
                     <de-DE>Rest</de-DE>
                 </name>
                 <name>
                     <bg-BG>Оставащи</bg-BG>
                 </name>
                 <is_dynamic>true</is_dynamic>
                 <calculation>
					<object code="most.opg_entry.rest_quantity:calculation_vsql" objectdef="calculation_vsql" module="core" >
						<select_value_statement><value>CAST (max_quantity-COALESCE((SELECT SUM(protocols.quantity) WHERE id = :VR__OUTER_SELECT_ID AND protocols.objectdef.code='protocol_sale'),0) AS INTEGER)</value></select_value_statement>
					</object>
				 </calculation>
             </rest_quantity>	
             
             <rest_quantity_percent>
                 <category>main.basic</category>
                 <sort_id>4001</sort_id>
                 <is_inmaintbl>false</is_inmaintbl>
                 <is_multiple>false</is_multiple>
                 <data_source>input</data_source>
                 <data_type>double</data_type>
                 <is_readonly>true</is_readonly>
                 <name>
                     <en-US>% Rest</en-US>
                 </name>
                 <name>
                     <de-DE>% Rest</de-DE>
                 </name>
                 <name>
                     <bg-BG>% Оставащи</bg-BG>
                 </name>	
                 <is_dynamic>true</is_dynamic>
                 <calculation>
                 	<object code="most.opg_entry.rest_quantity_percent:calculation_vsql" objectdef="calculation_vsql" module="core" >
						<select_value_statement><value>(max_quantity-COALESCE((SELECT SUM(protocols.quantity) WHERE id = :VR__OUTER_SELECT_ID AND protocols.objectdef.code='protocol_sale'),0))*100/max_quantity </value></select_value_statement>
					</object>
				 </calculation>
             </rest_quantity_percent>	
             
			 <protocols>
			 	<data_source>relation</data_source>
			 	<relation_parent>most.protocol.opg_entry</relation_parent>
			 	<category>main.basic</category>
                <sort_id>9000</sort_id>
                <is_hidden>true</is_hidden>
                <is_readonly>true</is_readonly>
 				<name>
                     <en-US>Protocols</en-US>
                 </name>
                 <name>
                     <de-DE>Protokole</de-DE>
                 </name>
                 <name>
                     <bg-BG>Протоколи</bg-BG>
                 </name>                 
			 </protocols>             
        	 
        	 <stocks>	
				<category>most.protocol_date.real.stock</category>
                <sort_id>2000</sort_id>
                <data_source>relation</data_source>
			 	<related_objectdef>most.protocol</related_objectdef>
			 	<is_multiple>true</is_multiple>
  				<name>
                    <en-US>Stocks</en-US>
                </name>
                <name>
                    <de-DE>Belieferungen</de-DE>
                </name>
                <name>
                    <bg-BG>Зареждания</bg-BG>
                </name>                
                 <is_dynamic>true</is_dynamic>
                 <calculation>
                     <object code="most.opg_entry.stocks:calculation_relation_path" module="core" objectdef="calculation_relation_path">
                         <property_code_path>
                             <value>protocols</value>
                         </property_code_path>
                         <where_statement>
                             <value>protocols.objectdef.code = 'protocol_stock'</value>
                         </where_statement>
                     </object>
                 </calculation>
        	</stocks>
        	
        	<sales>	
				<category>most.protocol_date.real.sale</category>
                <sort_id>2001</sort_id>
                <data_source>relation</data_source>
			 	<related_objectdef>most.protocol</related_objectdef>
			 	<is_multiple>true</is_multiple>
  				<name>
                    <en-US>Sales</en-US>
                </name>
                <name>
                    <de-DE>Verkäufe</de-DE>
                </name>
                <name>
                    <bg-BG>Продажби</bg-BG>
                </name>                
                 <is_dynamic>true</is_dynamic>
                 <calculation>
                     <object code="most.opg_entry.sales:calculation_relation_path" module="core" objectdef="calculation_relation_path">
                         <property_code_path>
                             <value>protocols</value>
                         </property_code_path>
                         <where_statement>
                             <value>protocols.objectdef.code = 'protocol_sale'</value>
                         </where_statement>
                     </object>
                 </calculation>
        	</sales>    
        	
        	<bundle_number>
				<category>main.basic</category>
                <sort_id>140</sort_id>
                <data_source>input</data_source>
                <data_type>varchar</data_type>
                <is_inmaintbl>true</is_inmaintbl>
  				<name>
                    <en-US>Bundle number</en-US>
                </name>
                <name>
                    <de-DE>Bündelnummer</de-DE>
                </name>
                <name>
                    <bg-BG>Вързоп номер</bg-BG>     
                </name>   	
        	</bundle_number>    			
			             				
		</opg_entry>
		
		<opg tbl="opg" copy_from="core.template_normal_transaction">

			<expires_on mode="delete"/>
			
			<import_time>
                <category>main.basic</category>
                <sort_id>9000</sort_id>
                <is_inmaintbl>true</is_inmaintbl>
                <data_source>input</data_source>
                <data_type>datetime</data_type>
                <name>
                    <en-US>Import time</en-US>
                </name>
                <name>
                    <de-DE>Importzeit</de-DE>
                </name>
                <name>
                    <bg-BG>Момент на импорт</bg-BG>
                </name>
                <is_hidden>false</is_hidden>
                <is_system>false</is_system>
                <is_readonly>true</is_readonly>
                <index_code>itm</index_code>
            </import_time>
			
			<code is_keep_settings="true">
				<is_unique>true</is_unique>
			</code>
			
			<discount_mode>
				<category>main.basic</category>
				<sort_id>999</sort_id>
				<is_inmaintbl>true</is_inmaintbl>
				<data_source>option</data_source>
				<option_set>discount_mode</option_set>
				<is_obligatory>true</is_obligatory>				
                <name>
                    <en-US>Discount mode</en-US>
                </name>
                <name>
                    <de-DE>Rapattmodus</de-DE>
                </name>
                <name>
                    <en-US>Вид отстъпка</en-US>
                </name>
			</discount_mode>			
			
			<entries>
				<category>main.basic</category>
				<sort_id>1000</sort_id>
				<is_inmaintbl>false</is_inmaintbl>
				<data_source>relation</data_source>
				<relation_parent>most.opg_entry.opg</relation_parent>
				<name>
				    <en-US>Entries</en-US>
				</name>
				<name>
				    <de-DE>Einträge</de-DE>
				</name>
				<name>
				    <bg-BG>Записи</bg-BG>
				</name>
				<display_type>property.relation.multiple.add.new</display_type>
				<relation_filter>core_property_default_relation_filter_simple_bidirectional_relation</relation_filter>
            </entries>
            
            <valid_from>
				<category>main.basic</category>
                <sort_id>110</sort_id>
                <data_source>input</data_source>
                <data_type>datetime</data_type>
                <is_inmaintbl>true</is_inmaintbl>
                <input_format>default_input_format_date</input_format>
                <output_format>default_output_format_date</output_format>
                <index_code>vf</index_code>
				<name>
                    <en-US>Valid from</en-US>
                </name>
                <name>
                    <de-DE>Valid von</de-DE>
                </name>
                <name>
                    <bg-BG>Валиден от</bg-BG>
                </name>                       
			</valid_from>	
						
			<valid_to>
				<category>main.basic</category>
                <sort_id>110</sort_id>
                <data_source>input</data_source>
                <data_type>datetime</data_type>
                <is_inmaintbl>true</is_inmaintbl>
                <input_format>default_input_format_date</input_format>
                <output_format>default_output_format_date</output_format>
                <index_code>eo</index_code>
				<name>
                    <en-US>Valid to</en-US>
                </name>
                <name>
                    <de-DE>Valid bis</de-DE>
                </name>
                <name>
                    <bg-BG>Валиден до</bg-BG>
                </name>                       
			</valid_to>	
			
			<version>
			 	<category>main.basic</category>
                <sort_id>199</sort_id>
                <data_source>input</data_source>
                <data_type>integer</data_type>
                <name>
                    <en-US>Version</en-US>
                </name>
                <name>
                    <de-DE>Version</de-DE>
                </name>
                <name>
                    <bg-BG>Версия</bg-BG>
                </name>
                <is_inmaintbl>true</is_inmaintbl>
                <min_value_integer>0</min_value_integer>
			 </version>

        	<on_delete_object>
                <category>actions.basic</category>
                <sort_id>300001</sort_id>
                <is_constant>true</is_constant>
                <is_hidden>true</is_hidden>
                <data_source>relation</data_source>
                <related_objectdef>core.script</related_objectdef>
                <default_value>
                    <object code="most.opg.on_delete_object:default_value" objectdef="vscript" module="core" >
                        <script_code>
                            <value><![CDATA[
for (var e : this.entries.OLD) {
    if(!e.is_deleted) {
	    e.delete();
	    e.commit();
    }
}                         
                        ]]></value>
                        </script_code>
                    </object>               
                </default_value>    
            </on_delete_object>  	
									
		</opg>

        <opg_entry_fixed parent_objectdef="most.opg_entry">
		</opg_entry_fixed>

		<opg_entry_percental parent_objectdef="most.opg_entry">
		</opg_entry_percental>

        <customer parent_objectdef="contacts.customer">

        	<abbreviation is_keep_settings="true">
        		<index_code>abr</index_code>
        	</abbreviation>
        	
			<sales>	
				<data_source>relation</data_source>
				<category>contacts.company.main.basic</category>
				<sort_id>8000</sort_id>
				<relation_parent>most.protocol_sale.customer</relation_parent>	
  				<name>
                    <en-US>Sales</en-US>
                </name>
                <name>
                    <de-DE>Verkäufe</de-DE>
                </name>
                <name>
                    <bg-BG>Продажби</bg-BG>
                </name>                
			</sales>

			<sales_current_month>
                 <category>contacts.company.main.basic</category>
                 <sort_id>9001</sort_id>
                 <is_inmaintbl>false</is_inmaintbl>
                 <is_multiple>false</is_multiple>
                 <data_source>input</data_source>
                 <data_type>double</data_type>
                 <is_readonly>true</is_readonly>
                 <name>
                     <en-US>This month total</en-US>
                 </name>
                 <name>
                     <de-DE>Disen Monat Total</de-DE>
                 </name>
                 <name>
                     <bg-BG>Този месец общо</bg-BG>
                 </name>
                 <is_dynamic>true</is_dynamic>
                 <calculation>
                     <object code="most.customer.sales_current_month:sum_calculation_relation_path" module="core" objectdef="calculation_relation_path_sum">
                         <property_code_path>
                             <value>sales.total</value>
                         </property_code_path>
                         <where_statement>
                             <value><![CDATA[ TO_CHAR(sales.official_date."date",'YYYYMM') = TO_CHAR(CURRENT_DATE,'YYYYMM') ]]></value>
                         </where_statement>
                     </object>
                 </calculation>
             </sales_current_month>
             			
			 <sales_30_days_total>
                 <category>contacts.company.main.basic</category>
                 <sort_id>9001</sort_id>
                 <is_inmaintbl>false</is_inmaintbl>
                 <is_multiple>false</is_multiple>
                 <data_source>input</data_source>
                 <data_type>double</data_type>
                 <is_readonly>true</is_readonly>
                 <name>
                     <en-US>30 Days total</en-US>
                 </name>
                 <name>
                     <de-DE>30 Tage insgesamt</de-DE>
                 </name>
                 <name>
                     <bg-BG>30 Дни общо</bg-BG>
                 </name>
                 <is_dynamic>true</is_dynamic>
                 <calculation>
                     <object code="most.customer.sales_30_days_total:sum_calculation_relation_path" module="core" objectdef="calculation_relation_path_sum">
                         <property_code_path>
                             <value>sales.total</value>
                         </property_code_path>
                         <where_statement>
                             <value><![CDATA[( DIFF(day,sales.official_date."date",CURRENT_TIMESTAMP) >= 0 AND DIFF(day,sales.official_date."date",CURRENT_TIMESTAMP) <= 30 ) ]]></value>
                         </where_statement>
                     </object>
                 </calculation>
              </sales_30_days_total>	
          
		</customer>

		<script_execution_context_daily_report_param parent_objectdef="core.script_execution_context">	

     		 <date>
     		 	<category>main.basic</category>
     		 	<data_source>relation</data_source>
                <rel_display_string_order>is_active DESC,"date"</rel_display_string_order>                
     		 	<related_objectdef>most.protocol_date</related_objectdef>
     		 	<relation_filter>
                     <object code="most.COMMON.protocol_date_filter:param" module="core" objectdef="relation_filter">
                        <get_related_objectdef_condition>
                            <value>
                                <object code="most.COMMON.protocol_date_filter:param:get_related_objectdef_condition" module="core" objectdef="vscript">
                                    <params>
                                         <value>
                                            <object code="object" module="core" objectdef="script_param"></object>
                                        </value>
                                        <value>
                                            <object code="property" module="core" objectdef="script_param"></object>
                                        </value>
                                    </params>
                                    <script_code>
                                        <value><![CDATA[
return "(is_active=1 OR is_show=1)";
                                    ]]></value>
                                    </script_code>
                                </object>
                            </value>
                        </get_related_objectdef_condition>
                   </object>
                </relation_filter>
     		 	<is_obligatory>true</is_obligatory>
     		 	<name>
                     <en-US>Date</en-US>
                 </name>
                 <name>
                     <de-DE>Datum</de-DE>
                 </name>
                 <name>
                     <bg-BG>Дата</bg-BG>
                 </name>
                <default_value_calculation>
                    <object code="most.script_execution_context_daily_report_param.date:default_value_calculation" module="core" objectdef="vscript">
                        <params>
                            <value>
                                <object code="id" module="core" objectdef="script_param" proj="all"></object>
                            </value>
                        </params>
                        <script_code>
                            <value><![CDATA[
var x = db.most.protocol_date.selectWhere("is_active = 1");
if (x.size == 1)
	return x[0];
return null;                            
                            ]]></value>
                        </script_code>
                    </object>
                </default_value_calculation>
             </date>
						
		</script_execution_context_daily_report_param>
		
				
		<state_adjustment_official tbl="stadjofc" copy_from="core.template_basic" is_abstract="true">

			<official_value>
                <category>main.basic</category>
                <sort_id>6000</sort_id>
                <is_inmaintbl>true</is_inmaintbl>
                <is_obligatory>true</is_obligatory>
                <data_source>input</data_source>
                <data_type>integer</data_type>
                <default_value>0</default_value>
                <name>
                    <en-US>Official value</en-US>
                    <de-DE>Offizieller Wert</de-DE>
                    <bg-BG>Официална стойност</bg-BG>
                </name>
			</official_value>
			
			
			<odit_entry>
                <category>main.basic</category>
                <sort_id>500</sort_id>
                <is_inmaintbl>true</is_inmaintbl>
                <is_readonly>true</is_readonly>
                <is_obligatory>true</is_obligatory>
                <data_source>relation</data_source>
                <related_objectdef>most.odit_entry</related_objectdef>
                <name>
                    <en-US>Odit entry</en-US>
                    <de-DE>Odit-Eintrag</de-DE>
                    <bg-BG>Запис ревизия</bg-BG>
                </name>
                <index_code>odt</index_code>
			</odit_entry>		
        
            <stock>
                <category>main.basic</category>
                <sort_id>199</sort_id>
                <data_source>relation</data_source>
                <related_objectdef>most.protocol_stock</related_objectdef>
                <name>
                    <en-US>Stock</en-US>
                </name>
                <name>
                    <de-DE>Belieferung</de-DE>
                </name>
                <name>
                    <bg-BG>Зареждане</bg-BG>
                </name>
                <is_obligatory>false</is_obligatory>
                <is_inmaintbl>true</is_inmaintbl>              
                <on_update_value mode="delete"/>
                <on_insert_value mode="delete"/>
                <on_delete_value mode="delete"/>
             </stock>
             
             <article>
				<category>main.basic</category>
				<display_type>property:most.protocol_sale.article</display_type>
                <sort_id>100</sort_id>
                <data_source>relation</data_source>
			 	<related_objectdef>most.article</related_objectdef>
			 	<is_obligatory>true</is_obligatory>			 	
                <is_inmaintbl>true</is_inmaintbl>
                <index_code>a</index_code>
			 </article>

			 <stock>
                <category>main.basic</category>
                <sort_id>199</sort_id>
                <data_source>relation</data_source>
                <related_objectdef>most.protocol_stock</related_objectdef>
                <is_inmaintbl>true</is_inmaintbl>
                <index_code>s</index_code>
             </stock>

     		 <date>
                <category>main.basic</category>
                <sort_id>150</sort_id>
                <is_inmaintbl>true</is_inmaintbl>
                <data_source>input</data_source>
                <data_type>datetime</data_type>
                <input_format>default_input_format_date</input_format>
                <output_format>default_output_format_date</output_format>
                <index_code>d</index_code>
             </date>
			
		</state_adjustment_official>
		
		<state_adjustment_real tbl="stadjreal" copy_from="core.template_basic" is_abstract="true">

			<real_value>
                <category>main.basic</category>
                <sort_id>6000</sort_id>
                <is_inmaintbl>true</is_inmaintbl>
                <is_obligatory>true</is_obligatory>
                <data_source>input</data_source>
                <data_type>integer</data_type>
                <default_value>0</default_value>
                <name>
                    <en-US>Real value</en-US>
                    <de-DE>Realer Wert</de-DE>
                    <bg-BG>Реална стойност</bg-BG>
                </name>
			</real_value>		
			
			<odit_entry>
                <category>main.basic</category>
                <sort_id>500</sort_id>
                <is_inmaintbl>true</is_inmaintbl>
                <is_readonly>true</is_readonly>
                <is_obligatory>true</is_obligatory>
                <data_source>relation</data_source>
                <related_objectdef>most.odit_entry</related_objectdef>
                <name>
                    <en-US>Odit entry</en-US>
                    <de-DE>Odit Eintrag</de-DE>
                    <bg-BG>Ревизия запис</bg-BG>
                </name>
                <is_unique>true</is_unique>
                <index_code>odt</index_code>
			</odit_entry>		

             <article>
				<category>main.basic</category>
				<display_type>property:most.protocol_sale.article</display_type>
                <sort_id>100</sort_id>
                <data_source>relation</data_source>
			 	<related_objectdef>most.article</related_objectdef>
			 	<is_obligatory>true</is_obligatory>			 	
                <is_inmaintbl>true</is_inmaintbl>
                <index_code>a</index_code>
			 </article>

     		 <date>
                <category>main.basic</category>
                <sort_id>150</sort_id>
                <is_inmaintbl>true</is_inmaintbl>
                <data_source>input</data_source>
                <data_type>datetime</data_type>
                <input_format>default_input_format_date</input_format>
                <output_format>default_output_format_date</output_format>
                <index_code>d</index_code>
             </date>
			
		</state_adjustment_real>
		
		
		
		<odit_entry tbl="odte" copy_from="core.template_normal_transaction" is_abstract="false">
					
			<code is_keep_settings="true">
				<is_unique>true</is_unique>
			</code>
			
			<expires_on mode="delete"/>			
					
			<odit>
                <category>main.basic</category>
                <sort_id>500</sort_id>
                <is_inmaintbl>true</is_inmaintbl>
                <is_readonly>false</is_readonly>
                <is_obligatory>true</is_obligatory>
                <data_source>relation</data_source>
                <related_objectdef>most.odit</related_objectdef>
                <name>
                    <en-US>Odit</en-US>
                    <de-DE>Odit</de-DE>
                    <bg-BG>Ревизия</bg-BG>
                </name>
                <index_code>odt</index_code>
			</odit>
		
		    <on_stock>
                 <category>main.basic</category>
                 <sort_id>1100</sort_id>
                 <is_inmaintbl>false</is_inmaintbl>
                 <is_multiple>false</is_multiple>
                 <data_source>input</data_source>
                 <data_type>integer</data_type>
                 <default_value>0</default_value>
                 <is_obligatory>true</is_obligatory>
                 <min_value_integer>0</min_value_integer>
  				 <name>
                    <en-US>MOST on stock</en-US>
                 </name>
                 <name>
                    <de-DE>MOST Verfügbarkeit</de-DE>
                 </name>
                 <name>
                    <bg-BG>MOST Наличност</bg-BG>
                 </name>
             </on_stock>

		    <on_stock_reported>
                 <category>main.basic</category>
                 <sort_id>1101</sort_id>
                 <is_inmaintbl>false</is_inmaintbl>
                 <is_multiple>false</is_multiple>
                 <data_source>input</data_source>
                 <data_type>integer</data_type>
                 <default_value>0</default_value>
                 <is_obligatory>true</is_obligatory>
                 <min_value_integer>0</min_value_integer>
  				 <name>
                    <en-US>HP on stock</en-US>
                 </name>
                 <name>
                    <de-DE>HP Verfügbarkeit</de-DE>
                 </name>
                 <name>
                    <bg-BG>HP Наличност</bg-BG>
                 </name>                
            </on_stock_reported>
			
			<article>
				<category>main.basic</category>
                <sort_id>600</sort_id>
                <data_source>relation</data_source>
			 	<related_objectdef>most.article</related_objectdef>
			 	<is_obligatory>true</is_obligatory>			 	
                <is_inmaintbl>true</is_inmaintbl>
                <index_code>a</index_code>
  				<name>
                    <en-US>Article</en-US>
                </name>
                <name>
                    <de-DE>Artikel</de-DE>
                </name>
                <name>
                    <bg-BG>Артикул</bg-BG>
                </name>                
			 </article>

			 <on_update_object mode="delete"/>
			 <recalc_state>
				<is_constant>true</is_constant>
				<data_source>relation</data_source>
				<related_objectdef>core.vscript</related_objectdef>
				<default_value>
					<object code="most.odit_entry.recalc_state" objectdef="vscript" module="core" >
						<script_code>
							<value><![CDATA[

if (this.odit != null && this.odit.is_active && this.article != null) 
{
	var sel = db.most.state_adjustment_official.SELECT("odit_entry=:ID");
	sel["ID"]=this.id;
	for (var e : sel) {
		e.delete();
		e.commit();
	}

	var sel = db.most.state_adjustment_real.SELECT("odit_entry=:ID");
	sel["ID"]=this.id;
	for (var e : sel) {
		e.delete();
		e.commit();
	}

	var params=new M();
	params["AID"]=this.article.id;
	params["DID"]=this.odit.date.id;	
	params["DTE"]=this.odit.date.date;

	var tstocked=0;
	var tsold=0;
	//TOTAL STOCKED OFFICIAL
	var sl  = db.most.protocol_stock.VSQL_QUERY_SUM("SELECT quantity AS VAL WHERE article = :AID AND official_date.\"date\" <= :DTE",params);	
	if (sl.next() && sl.getInt("RES") != null) tstocked=sl.getInt("RES");

	//TOTAL SOLD  OFFICIAL
	var sl  = db.most.protocol_sale.VSQL_QUERY_SUM("SELECT quantity AS VAL WHERE stock.article = :AID AND official_date.\"date\" <= :DTE AND stock IS NOT NULL",params);	
	if (sl.next() && sl.getInt("RES") != null) tsold=sl.getInt("RES");
	sl  = db.most.state_adjustment_official.VSQL_QUERY_SUM("SELECT official_value AS VAL WHERE article = :AID AND \"date\" <= :DTE",params);
	if (sl.next() && sl.getInt("RES") != null) tsold+=sl.getInt("RES");
	
	//  tstocked_reported - (tsold_reported + X) = on_stock_reported
	//  tstocked_reported - tsold_reported - X) = on_stock_reported
	//  - X = on_stock_reported - tstocked_reported + tsold_reported;
	//  X = tstocked_reported - on_stock_reported -  tsold_reported;
	
	// kolko oshte SALES trqbwa da naprawim na taq data 4e da izlezne smetkata 	
	// zna4i imame razlikata koqto trabwa da se ADDNE kam sale (!! polojitelna)

	var terr=this.odit.TEMP["terr"];
	if (terr == null) 
	{
		terr=0;
		this.odit.TEMP["terr"].reset(terr);
		db.addExecutionAfterCommit(function(param) 
        {
          java.log.warn("FINISH is_active SET for ODIT "+param+" | ERR="+param.TEMP["terr"]+" | OK="+param.TEMP["done"]);
        },this.odit);
		
	}
	var tdone=this.odit.TEMP["done"];
	if (tdone == null) {
		tdone=0;
		this.odit.TEMP["done"].reset(terr);
	}
	
	var diff_official = tstocked - this.on_stock_reported - tsold;
	if (diff_official != 0) 
	{
		if (diff_official < 0) {
		    java.log.info("FOR ARTICLE="+this.article.code+" | HP="+this.on_stock_reported+" | MOST="+this.on_stock+" | TSTOCKED="+tstocked+" | TSOLD="+tsold);
			java.log.error("CAN NOT DISTRIBUTE odit value TO STOCKS | DATE="+this.odit.date+" | ARTICLE = "+this.article+" | OFFICIAL "+this.on_stock_reported +" | REAL "+this.on_stock +" | DIFF OFFIC "+(diff_official));
			terr++;
			this.odit.TEMP["terr"].reset(terr);
		} else {
			var oval = diff_official;
			var cr = "CAST ((quantity - COALESCE((SELECT SUM(sales.quantity) WHERE id = :VR__OUTER_SELECT_ID AND sales.official_date.\"date\" <= :DTE ),0) - COALESCE((SELECT SUM(official_value) FROM most.state_adjustment_official WHERE stock = :VR__OUTER_SELECT_ID AND \"date\" <= :DTE),0))  AS  INTEGER)"; 
			var sl = db.most.protocol_stock.SELECT("official_date.\"date\" <= :DTE AND article = :AID AND "+cr+" > 0 ORDER by real_date.\"date\", "+cr+" DESC,id") ;
			sl["AID"]=this.article.id;
			sl["DTE"]=this.odit.date.date;			
			for (var e : sl) {
				tstocked=0;
				tsold=0;
				params["EID"]=e.id;
				var sl = db.most.protocol_sale.VSQL_QUERY_SUM("SELECT quantity AS VAL WHERE stock = :EID AND official_date.\"date\" <= :DTE AND stock IS NOT NULL",params);
				if (sl.next() && sl.getInt("RES") != null) tsold=sl.getInt("RES");
				var avail = e.quantity-tsold;
				var cc = diff_official < avail ? diff_official : avail;
				var o = new db.most.state_adjustment_official();
				o.odit_entry=this;
				o.stock=e;		
				o.official_value=cc;
				o.article=this.article;
				o.date=this.odit.date.date;
				o.commit();
				diff_official-=cc;
				if (diff_official == 0) {
					tdone++;
					this.odit.TEMP["done"].reset(tdone);
					break;
				}
			}
			if (diff_official > 0) {
				java.log.info("FOR ARTICLE="+this.article.code+" | HP="+this.on_stock_reported+" | MOST="+this.on_stock+" | TSTOCKED="+tstocked+" | TSOLD="+tsold);
				java.log.error("CAN NOT assign stocks to "+oval+" to "+sl.size+" stocks (more left " + diff_official + ")| DATE="+this.odit.date+" | ARTICLE = "+this.article+" | OFFICIAL "+this.on_stock_reported +" | REAL "+this.on_stock +" | DIFF OFFIC "+(diff_official)+" | "+this.toString()+"");
				terr++;
				this.odit.TEMP["terr"].reset(terr);
			}			
		}  
	}		

	// NOW FOR REAL DATA
	tstocked=0;
	tsold=0;
	
	//TOTAL STOCKED REAL
	var sl  = db.most.protocol_stock.VSQL_QUERY_SUM("SELECT quantity AS VAL WHERE article = :AID AND real_date.\"date\" <= :DTE",params);
	if (sl.next() && sl.getInt("RES") != null) tstocked=sl.getInt("RES");

	//TOTAL SOLD REAL
	var sl  = db.most.protocol_sale.VSQL_QUERY_SUM("SELECT quantity AS VAL WHERE article = :AID AND real_date.\"date\" <= :DTE",params);
	if (sl.next() && sl.getInt("RES") != null) tsold=sl.getInt("RES");
	sl  = db.most.state_adjustment_real.VSQL_QUERY_SUM("SELECT real_value AS VAL WHERE article = :AID AND \"date\" <= :DTE",params);
	if (sl.next() && sl.getInt("RES") != null) tsold+=sl.getInt("RES");
	
	//  tstocked_reported - (tsold_reported + X) = on_stock_reported
	//  tstocked_reported - tsold_reported - X) = on_stock_reported
	//  - X = on_stock_reported - tstocked_reported + tsold_reported;
	//  X = tstocked_reported - on_stock_reported -  tsold_reported;
	
	var diff_real  = tstocked - this.on_stock_reported - tsold;
	if (diff_real != 0) {
		var o = new db.most.state_adjustment_real();
		o.odit_entry=this;
		o.article=this.article;
		o.date=this.odit.date.date;
		o.real_value = diff_real;
		o.commit();
	}	
}

]]>
							</value>
						</script_code>
					</object>				
				</default_value>
				<is_hidden>true</is_hidden>
			</recalc_state>
			     
			<on_delete_object>
				<is_hidden>true</is_hidden>
				<is_constant>true</is_constant>
				<data_source>relation</data_source>
				<related_objectdef>core.vscript</related_objectdef>
				<default_value>
					<object code="most.odit_entry.on_delete_object" objectdef="vscript" module="core" >
						<script_code>
							<value>
for (var e : db.most.state_adjustment_real.selectWhere("odit_entry="+this.id)) {
	e.delete();
	e.commit();
}
for (var e : db.most.state_adjustment_official.selectWhere("odit_entry="+this.id)) {
	e.delete();
	e.commit();
}

							</value>
						</script_code>
					</object>				
				</default_value>
			</on_delete_object>
						
			<official_adjustments>
				<category>main.basic</category>
				<data_source>relation</data_source>
				<relation_parent>most.state_adjustment_official.odit_entry</relation_parent>
			</official_adjustments>

			<real_adjustment>
				<category>main.basic</category>
				<data_source>relation</data_source>
				<relation_parent>most.state_adjustment_real.odit_entry</relation_parent>
			</real_adjustment>

			<real_adjustments mode="delete"/>
		</odit_entry>
		
		
		<odit tbl="odt" copy_from="core.template_normal_transaction" is_abstract="true">

			 <code is_keep_settings="true">
				<is_unique>true</is_unique>
			 </code>

			<date>
                <category>main.basic</category>
                <sort_id>500</sort_id>
                <is_inmaintbl>true</is_inmaintbl>
                <data_source>relation</data_source>
                <rel_display_string_order>is_active DESC,"date"</rel_display_string_order>                
                <related_objectdef>most.protocol_date</related_objectdef>
                <name>
                    <en-US>Date</en-US>
                </name>
                <name>
                    <de-DE>Datum</de-DE>
                </name>
                <name>
                    <bg-BG>Дата</bg-BG>
                </name>                             
                <index_code>dt</index_code>
        	</date>
        		
			<entries>	
        		<is_hidden>false</is_hidden>
				<category>main.basic</category>
                <sort_id>1500</sort_id>
                <data_source>relation</data_source>
			 	<relation_parent>most.odit_entry.odit</relation_parent>
  				<name>
                    <en-US>Entries</en-US>
                </name>
                <name>
                    <de-DE>Einträge</de-DE>
                </name>
                <name>
                    <bg-BG>Записи</bg-BG>
                </name>          
				<display_type>property.relation.multiple.add.new</display_type>
				<relation_filter>core_property_default_relation_filter_simple_bidirectional_relation</relation_filter>
        	</entries>

            <is_active>
             	<category>main.basic</category>
                <sort_id>500</sort_id>
                <is_inmaintbl>true</is_inmaintbl>
                <is_obligatory>true</is_obligatory>
                <data_source>option</data_source>
                <option_set>boolean</option_set>
                <name>
                    <en-US>Active?</en-US>
                </name>
                <name>
                    <de-DE>Aktiv?</de-DE>
                </name>
                <name>
                    <bg-BG>Активна?</bg-BG>
                </name>	
                <default_value>false</default_value>
                <on_update_value>
                    <object code="most.odit.is_active:on_change" module="core" objectdef="vscript">                       
                        <script_code>
                            <value><![CDATA[
if (this.is_active) 
{	
	for (var e : db.most.state_adjustment_official.SELECT()) {
		e.delete();
		e.commit();
	}
	for (var e : db.most.state_adjustment_real.SELECT()) {
		e.delete();
		e.commit();
	}
	var ss = db.most.odit.SELECT("is_active = 1 ORDER BY \"date\".\"date\"");
	ss.is_cached=false;
	if (!ss.is_empty) 
	{
		var first=ss[0];
		for (var g : ss)
		{
			var entries = db.most.odit_entry.SELECT("odit=:OID ORDER by on_stock_reported DESC,id");
			entries["OID"]=g.id;			
			for (var k : entries) { 
				k.recalc_state();
				k.commit();
			}
			if (g == first) 
			{
				// CHECK MISSING?
				var ks1 = db.most.article.SELECT("id NOT IN (SELECT article from most.odit_entry WHERE odit = :OID)");
				ks1["OID"]=g.id;
				for (var a : ks1) 
				{
					var params = new M();
					params["DTE"]=g.date.date;
					params["AID"]=a.id;
					
					var tstocked=0;
					var tsold=0;
					var sl  = db.most.protocol_stock.VSQL_QUERY_SUM("SELECT quantity AS VAL WHERE article = :AID AND official_date.\"date\" <= :DTE",params);	
					if (sl.next() && sl.getInt("RES") != null) tstocked=sl.getInt("RES");
					var sl  = db.most.protocol_sale.VSQL_QUERY_SUM("SELECT quantity AS VAL WHERE stock.article = :AID AND official_date.\"date\" <= :DTE AND stock IS NOT NULL",params);	
					if (sl.next() && sl.getInt("RES") != null) tsold=sl.getInt("RES");
					
					//TOTAL STOCKED OFFICIAL
					var diff_official = tstocked - tsold;
					if (diff_official != 0) 
					{
						java.log.info("ADJUST MISSING ARTICLE ODIT : "+a.code);
						if (diff_official < 0) {
						    java.log.info("2) FOR ARTICLE="+a.code+" | HP="+0+" | MOST="+0+" | TSTOCKED="+tstocked+" | TSOLD="+tsold);
							java.log.error("2) CAN NOT DISTRIBUTE odit value TO STOCKS | DATE="+g.date+" | ARTICLE = "+a+" | OFFICIAL 0 | REAL 0 | DIFF OFFIC "+(diff_official));
						} else {
							var oval = diff_official; 
							var cr = "CAST ((quantity - COALESCE((SELECT SUM(sales.quantity) WHERE id = :VR__OUTER_SELECT_ID AND sales.official_date.\"date\" <= :DTE ),0) - COALESCE((SELECT SUM(official_value) FROM most.state_adjustment_official WHERE stock = :VR__OUTER_SELECT_ID AND \"date\" <= :DTE),0)) AS INTEGER)"; 
							var sl = db.most.protocol_stock.SELECT("official_date.\"date\" <= :DTE AND article = :AID AND "+cr+" > 0 ORDER by quantity,real_date.\"date\","+cr+" DESC,id") ;
							sl["DTE"]=g.date.date;
							sl["AID"]=a.id;
							for (var e : sl) 
							{
								tstocked=0;
								tsold=0;
								params["EID"]=e.id;
								var sl = db.most.protocol_sale.VSQL_QUERY_SUM("SELECT quantity AS VAL WHERE stock = :EID AND official_date.\"date\" <= :DTE AND stock IS NOT NULL",params);
								if (sl.next() && sl.getInt("RES") != null) tsold=sl.getInt("RES");
								var avail = e.quantity-tsold;
								var cc = diff_official < avail ? diff_official : avail;
								var o = new db.most.state_adjustment_official();
								o.article=a;
								o.date=g.date.date;
								o.stock=e;		
								o.official_value=cc;
								o.commit();
								diff_official-=cc;
								if (diff_official == 0) {										
									break;
								}
							}
							if (diff_official > 0) {
								java.log.info("2) FOR ARTICLE="+a.code+" | HP=0 | MOST=0 | TSTOCKED="+tstocked+" | TSOLD="+tsold);
								java.log.error("2) CAN NOT assign stocks to "+oval+" to "+sl.size+" stocks (more left " + diff_official + ") | DATE="+g.date+" | ARTICLE = "+a+" | OFFICIAL 0 | REAL 0 | DIFF OFFIC "+diff_official);
							}			
						}  
						// NOW FOR REAL DATA
						tstocked=0;
						tsold=0;
						
						//TOTAL STOCKED REAL
						var sl  = db.most.protocol_stock.VSQL_QUERY_SUM("SELECT quantity AS VAL WHERE article = :AID AND real_date.\"date\" <= :DTE",params);
						if (sl.next() && sl.getInt("RES") != null) tstocked=sl.getInt("RES");
					
						//TOTAL SOLD REAL
						var sl  = db.most.protocol_sale.VSQL_QUERY_SUM("SELECT quantity AS VAL WHERE article = :AID AND real_date.\"date\" <= :DTE",params);
						if (sl.next() && sl.getInt("RES") != null) tsold=sl.getInt("RES");

						var diff_real  = tstocked - tsold;
						if (diff_real != 0) {
							var o = new db.most.state_adjustment_real();
							o.real_value = diff_real;
							o.article=a;
							o.date=g.date.date;
							o.commit();
						}						
					}
				} 
			}
		}
	}
} else {
	var ss = db.most.odit.SELECT("is_active = 1");
	ss.is_cached=false;
	if (ss.size == 0) {
		for (var e : db.most.state_adjustment_official.SELECT()) {
			e.delete();
			e.commit();
		}
		for (var e : db.most.state_adjustment_real.SELECT()) {
			e.delete();
			e.commit();
		}
	} else {
		var sel = db.most.state_adjustment_official.SELECT("odit_entry.odit=:ID");
		sel["ID"]=this.id;
		for (var e : sel) {
			e.delete();
			e.commit();
		}
		var sel = db.most.state_adjustment_real.SELECT("odit_entry.odit=:ID");
		sel["ID"]=this.id;
		for (var e : sel) {
			e.delete();
			e.commit();
		}
	}
}
                        ]]></value>
                        </script_code>
                    </object>
                </on_update_value>
             </is_active>		        

        	<on_delete_object>
                <category>actions.basic</category>
                <sort_id>300001</sort_id>
                <is_constant>true</is_constant>
                <is_hidden>true</is_hidden>
                <data_source>relation</data_source>
                <related_objectdef>core.script</related_objectdef>
                <default_value>
                    <object code="most.odit.on_delete_object:default_value" objectdef="vscript" module="core" >
                        <script_code>
                            <value><![CDATA[
for (var e : this.entries.OLD) {
    if(!e.is_deleted) {
	    e.delete();
	    e.commit();
    }
}                         
                        ]]></value>
                        </script_code>
                    </object>               
                </default_value>    
            </on_delete_object>  	

		</odit> 		
		
		
		<article copy_from="core.template_normal_transaction" is_abstract="false" tbl="art">

			<code is_keep_settings="true">
				<is_unique>true</is_unique>
			</code>

			<vendor>
                <category>main.settings</category>
                <sort_id>450</sort_id>
                <data_source>relation</data_source>
                <related_objectdef>contacts.vendor</related_objectdef>
                <name>
                    <en-US>Vendor</en-US>
                </name>
                <name>
                    <de-DE>Lieferant</de-DE>
                </name>
                <name>
                    <bg-BG>Доставчик</bg-BG>
                </name>
                <is_hidden>false</is_hidden>
                <is_obligatory>true</is_obligatory>
                <is_inmaintbl>true</is_inmaintbl>
                <display_type mode="delete"/>
            </vendor>        

        	<product_line col="prod_line">
				<data_source>relation</data_source>
				<data_type>integer</data_type>
				<is_inmaintbl>true</is_inmaintbl>
				<is_obligatory>true</is_obligatory>
				<index_code>prl</index_code>
				<sort_id>5000</sort_id>
                <category>main.settings</category>
                <related_objectdef>most.product_line</related_objectdef>
	  			<name>
	            	<en-US>Product line</en-US>
	            	<de-DE>Produktlinie</de-DE>
	            	<bg-BG>Продуктова линия</bg-BG>
	            </name>
			</product_line>
			        
        	<protocols>	
        		<is_hidden>true</is_hidden>
				<category>main.basic</category>
                <sort_id>999</sort_id>
                <data_source>relation</data_source>
			 	<relation_parent>most.protocol.article</relation_parent>
  				<name>
                    <en-US>Protocols</en-US>
                </name>
                <name>
                    <de-DE>Protokole</de-DE>
                </name>
                <name>
                    <bg-BG>Протоколи</bg-BG>
                </name>                
        	</protocols>

        	<opg_entries>	
				<category>most.article.related.additional</category>
                <sort_id>1000</sort_id>
                <data_source>relation</data_source>
			 	<relation_parent>most.opg_entry.article</relation_parent>
  				<name>
                    <en-US>OPG entries</en-US>
                </name>
                <name>
                    <de-DE>OPG-Einträge</de-DE>
                </name>
                <name>
                    <bg-BG>OPG записи</bg-BG>
                </name>                
        	</opg_entries>

        	<stocks>	
				<category>most.article.related.protocols</category>
                <sort_id>1001</sort_id>
                <data_source>relation</data_source>
			 	<related_objectdef>most.protocol</related_objectdef>
			 	<is_multiple>true</is_multiple>
  				<name>
                    <en-US>Stocks</en-US>
                </name>
                <name>
                    <de-DE>Belieferungen</de-DE>
                </name>
                <name>
                    <bg-BG>Зареждания</bg-BG>
                </name>                
                 <is_dynamic>true</is_dynamic>
                 <calculation>
                     <object code="most.article.stocks:calculation_relation_path" module="core" objectdef="calculation_relation_path">
                         <property_code_path>
                             <value>protocols</value>
                         </property_code_path>
                         <where_statement>
                             <value>protocols.objectdef.code = 'protocol_stock'</value>
                         </where_statement>
                     </object>
                 </calculation>
        	</stocks>

        	<sales>	
				<category>most.article.related.protocols</category>
                <sort_id>1001</sort_id>
                <data_source>relation</data_source>
			 	<related_objectdef>most.protocol</related_objectdef>
			 	<is_multiple>true</is_multiple>
  				<name>
                    <en-US>Sales</en-US>
                </name>
                <name>
                    <de-DE>Verkäufe</de-DE>
                </name>
                <name>
                    <bg-BG>Продажби</bg-BG>
                </name>                
                <calculation>
                     <object code="most.article.sales:calculation_relation_path" module="core" objectdef="calculation_relation_path">
                         <property_code_path>
                             <value>protocols</value>
                         </property_code_path>
                         <where_statement>
                             <value>protocols.objectdef.code = 'protocol_sale'</value>
                         </where_statement>
                     </object>
                 </calculation>
        	</sales>        	
        	
        	<invoices>	
				<category>most.article.related.additional</category>
                <sort_id>1002</sort_id>
                <data_source>relation</data_source>
			 	<relation_parent>most.invoice.article</relation_parent>
			 	<is_multiple>true</is_multiple>
  				<name>
                    <en-US>Invoices</en-US>
                </name>
                <name>
                    <de-DE>Rechnungen</de-DE>
                </name>
                <name>
                    <bg-BG>Фактури</bg-BG>
                </name>                               
        	</invoices>        	
        	
        	<odit_entries>	
				<category>most.article.related.additional</category>
                <sort_id>1002</sort_id>
                <data_source>relation</data_source>
			 	<relation_parent>most.odit_entry.article</relation_parent>
			 	<is_multiple>true</is_multiple>
  				<name>
                    <en-US>Odit entries</en-US>
                </name>
                <name>
                    <de-DE>Odit-Einträge</de-DE>
                </name>
                <name>
                    <bg-BG>Записи ревизия</bg-BG>
                </name>                               
        	</odit_entries>

			<opgs>
				<category>most.article.related.additional</category>
                <sort_id>1003</sort_id>
                <data_source>relation</data_source>
			 	<related_objectdef>most.opg</related_objectdef>
			 	<is_multiple>true</is_multiple>
			 	<is_dynamic>true</is_dynamic>
  				<name>
                    <en-US>OPGs</en-US>
                </name>
                <name>
                    <de-DE>OPG</de-DE>
                </name>
                <name>
                    <bg-BG>OPG-та</bg-BG>
                </name>                
                <calculation>
                     <object code="most.article.opgs:calculation_relation_path" module="core" objectdef="calculation_relation_path">
                         <property_code_path>
                             <value>opg_entries.opg</value>
                         </property_code_path>
                     </object>
                 </calculation>
        	</opgs>
        	
        	<odit_entry>
                <category>main.settings</category>
                <sort_id>9000</sort_id>
                <data_source>relation</data_source>
                <is_multiple>false</is_multiple>
                <is_readonly>false</is_readonly>
                <related_objectdef>most.odit_entry</related_objectdef>
                <is_dynamic>true</is_dynamic>
                <name>
                    <en-US>Odit (entry)</en-US>
                    <de-DE>Odit (Eintrag)</de-DE>
                    <bg-BG>Ревизия (запис)</bg-BG>
                </name>
             	<index_code>oge</index_code>
             	<is_dynamic>true</is_dynamic>               
                <calculation>
	     			<object code="most.article.odit_entry:calculation_relation_path" module="core" objectdef="calculation_relation_path">
                         <property_code_path>
                             <value>odit_entries</value>
                         </property_code_path>
                         <where_statement>
                             <value>odit_entries.id IN (SELECT odit_entries.id WHERE id = :VR__OUTER_SELECT_ID ORDER BY odit_entries.odit."date"."date" DESC LIMIT 1 )</value>
                         </where_statement>
                     </object>
                 </calculation>
             </odit_entry>
             
            <delta>
                 <category>main.basic</category>
                 <sort_id>10003</sort_id>
                 <is_inmaintbl>false</is_inmaintbl>
                 <is_multiple>false</is_multiple>
                 <data_source>input</data_source>
                 <data_type>integer</data_type>
                 <is_readonly>true</is_readonly>
                 <name>
                     <en-US>Delta (MO-HP)</en-US>
                 </name>
                 <name>
                     <de-DE>Delta (MO-HP)</de-DE>
                 </name>
                 <name>
                     <bg-BG>Делта (MO-HP)</bg-BG>
                 </name>
                 <is_dynamic>true</is_dynamic>
                 <calculation>
                 	<object code="most.article.delta:calculation_vsql" objectdef="calculation_vsql" module="core" >
						<select_value_statement><value><![CDATA[ available_real - available_official ]]></value></select_value_statement>
					</object>
				 </calculation>
             </delta> 
             
             <total_stocked_official>
                 <category>main.basic</category>
                 <sort_id>9000</sort_id>
                 <is_inmaintbl>false</is_inmaintbl>
                 <is_multiple>false</is_multiple>
                 <data_source>input</data_source>
                 <data_type>integer</data_type>
                 <is_readonly>true</is_readonly>
                 <name>
                     <en-US>Official stocked</en-US>
                 </name>
                 <name>
                     <de-DE>Beliefert offiziel</de-DE>
                 </name>
                 <name>
                     <bg-BG>Заредено официално</bg-BG>
                 </name>
                 <is_dynamic>true</is_dynamic>
                 <calculation>
                 	<object code="most.article.total_stocked_official:calculation_vsql" objectdef="calculation_vsql" module="core" >
						<select_value_statement><value><![CDATA[CAST ( COALESCE((SELECT SUM(protocols.quantity) WHERE id = :VR__OUTER_SELECT_ID AND protocols.objectdef.code='protocol_stock' AND protocols.official_date."date" <= CURRENT_TIMESTAMP ),0) AS INTEGER)]]></value></select_value_statement>
					</object>
				 </calculation>
             </total_stocked_official>
                       
             <total_sold_official>
                 <category>main.basic</category>
                 <sort_id>9001</sort_id>
                 <is_inmaintbl>false</is_inmaintbl>
                 <is_multiple>false</is_multiple>
                 <data_source>input</data_source>
                 <data_type>integer</data_type>
                 <is_readonly>true</is_readonly>
                  <name>
                     <en-US>Sold official</en-US>
                 </name>
                 <name>
                     <de-DE>Verkauft offiziel</de-DE>
                 </name>
                 <name>
                     <bg-BG>Продадени официално</bg-BG>
                 </name>
                 <is_dynamic>true</is_dynamic>
                 <calculation>
                 	<object code="most.article.total_sold_official:calculation_vsql" objectdef="calculation_vsql" module="core" >
						<select_value_statement><value><![CDATA[CAST ( COALESCE((SELECT SUM(protocols.quantity) WHERE id = :VR__OUTER_SELECT_ID AND protocols.objectdef.code='protocol_sale' AND protocols.stock IS NOT NULL AND protocols.official_date."date" <= CURRENT_TIMESTAMP ),0) + COALESCE((SELECT SUM(official_value) FROM most.state_adjustment_official WHERE article = :VR__OUTER_SELECT_ID),0) AS INTEGER)]]></value></select_value_statement>
					</object>
				 </calculation>
             </total_sold_official>                  
             
             <available_official>
				 <category>main.basic</category>
                 <sort_id>9002</sort_id>
                 <is_inmaintbl>false</is_inmaintbl>
                 <is_multiple>false</is_multiple>
                 <data_source>input</data_source>
                 <data_type>integer</data_type>
                 <is_readonly>true</is_readonly>
                 <name>
                     <en-US>Official availability</en-US>
                 </name>
                 <name>
                     <de-DE>Offiziele Verfügbarkeit</de-DE>
                 </name>
                 <name>
                     <bg-BG>Наличност официална</bg-BG>
                 </name>
                 <is_dynamic>true</is_dynamic>
                 <calculation>
                 	<object code="most.article.available_official:calculation_vsql" objectdef="calculation_vsql" module="core" >
						<select_value_statement><value><![CDATA[CAST ( CAST ( COALESCE((SELECT SUM(protocols.quantity) WHERE id = :VR__OUTER_SELECT_ID AND protocols.objectdef.code='protocol_stock' AND protocols.official_date."date" <= CURRENT_TIMESTAMP ),0) AS INTEGER) - COALESCE((SELECT SUM(protocols.quantity) WHERE id = :VR__OUTER_SELECT_ID AND protocols.objectdef.code='protocol_sale' AND protocols.stock IS NOT NULL AND protocols.official_date."date" <= CURRENT_TIMESTAMP ),0) - COALESCE((SELECT SUM(official_value) FROM most.state_adjustment_official WHERE article = :VR__OUTER_SELECT_ID),0) AS INTEGER)]]></value></select_value_statement>
					</object>
				 </calculation>
             </available_official>  
             
                         
			 <total_stocked_real>
                 <category>main.basic</category>
                 <sort_id>9100</sort_id>
                 <is_inmaintbl>false</is_inmaintbl>
                 <is_multiple>false</is_multiple>
                 <data_source>input</data_source>
                 <data_type>integer</data_type>
                 <is_readonly>true</is_readonly>
                 <name>
                     <en-US>Stocked real</en-US>
                 </name>
                 <name>
                     <de-DE>Beliefert real</de-DE>
                 </name>
                 <name>
                     <bg-BG>Заредено реално</bg-BG>
                 </name>
                 <is_dynamic>true</is_dynamic>
                 <calculation>
                 	<object code="most.article.total_stocked_real:calculation_vsql" objectdef="calculation_vsql" module="core" >
						<select_value_statement><value><![CDATA[CAST ( COALESCE((SELECT SUM(protocols.quantity) WHERE id = :VR__OUTER_SELECT_ID AND protocols.objectdef.code='protocol_stock'),0) AS INTEGER)]]></value></select_value_statement>
					</object>
				 </calculation>
             </total_stocked_real>  
                       
             <total_sold_real>
                 <category>main.basic</category>
                 <sort_id>9101</sort_id>
                 <is_inmaintbl>false</is_inmaintbl>
                 <is_multiple>false</is_multiple>
                 <data_source>input</data_source>
                 <data_type>integer</data_type>
                 <is_readonly>true</is_readonly>
                  <name>
                     <en-US>Sold real</en-US>
                 </name>
                 <name>
                     <de-DE>Verkauft real</de-DE>
                 </name>
                 <name>
                     <bg-BG>Продадени реално</bg-BG>
                 </name>
                 <is_dynamic>true</is_dynamic>
                 <calculation>
                 	<object code="most.article.total_sold:calculation_vsql" objectdef="calculation_vsql" module="core" >
						<select_value_statement><value><![CDATA[CAST ( COALESCE((SELECT SUM(protocols.quantity) WHERE id = :VR__OUTER_SELECT_ID AND protocols.objectdef.code='protocol_sale'),0) + COALESCE((SELECT SUM(real_value) FROM most.state_adjustment_real WHERE article = :VR__OUTER_SELECT_ID),0) AS INTEGER)]]></value></select_value_statement>
					</object>
				 </calculation>
             </total_sold_real>      
                          
             <available_real>
                 <category>main.basic</category>
                 <sort_id>9102</sort_id>
                 <is_inmaintbl>false</is_inmaintbl>
                 <is_multiple>false</is_multiple>
                 <data_source>input</data_source>
                 <data_type>integer</data_type>
                 <is_readonly>true</is_readonly>
                 <name>
                     <en-US>Real availability</en-US>
                 </name>
                 <name>
                     <de-DE>Reale Verfügbarkeit</de-DE>
                 </name>
                 <name>
                     <bg-BG>Наличност реална</bg-BG>
                 </name>
                 <is_dynamic>true</is_dynamic>
                 <calculation>
                 	<object code="most.article.available_real:calculation_vsql" objectdef="calculation_vsql" module="core" >
						<select_value_statement><value><![CDATA[CAST ( CAST ( COALESCE((SELECT SUM(protocols.quantity) WHERE id = :VR__OUTER_SELECT_ID AND protocols.objectdef.code='protocol_stock'),0) AS INTEGER) - COALESCE((SELECT SUM(protocols.quantity) WHERE id = :VR__OUTER_SELECT_ID AND protocols.objectdef.code='protocol_sale'),0) - COALESCE((SELECT SUM(real_value) FROM most.state_adjustment_real WHERE article = :VR__OUTER_SELECT_ID),0) AS INTEGER)]]></value></select_value_statement>
					</object>
				 </calculation>
             </available_real>                   
             
        </article>
        
		<product_line copy_from="core.template_normal_transaction" is_abstract="false" tbl="prl">

			 <delta mode="delete"/>

	 		 <objectdef is_keep_settings="true">
	 		 	<is_hidden>true</is_hidden>
	 		 </objectdef>
	 		 <code is_keep_settings="true">
				<is_unique>true</is_unique>
			 </code>
			 
     		 <articles>
                <category>main.basic</category>
                <data_source>relation</data_source>
                <relation_parent>most.article.product_line</relation_parent>
                <name>
                    <en-US>Articles</en-US>
                </name>
                <name>
                    <de-DE>Artikel</de-DE>
                </name>
                <name>
                    <bg-BG>Артикули</bg-BG>
                </name>
				<display_type>property.relation.multiple.add.new</display_type>
				<relation_filter>core_property_default_relation_filter_simple_bidirectional_relation</relation_filter>
				<sort_id>500</sort_id>
             </articles>
         	 
         	 <product_group>
				<data_source>relation</data_source>
				<data_type>integer</data_type>
				<is_inmaintbl>true</is_inmaintbl>
				<is_obligatory>true</is_obligatory>
				<index_code>pg</index_code>
				<sort_id>1000</sort_id>
                <category>main.basic</category>
                <related_objectdef>most.product_group</related_objectdef>
	  			<name>
	            	<en-US>Product group</en-US>
	            	<de-DE>Produktgruppe</de-DE>
	            	<bg-BG>Продуктова група</bg-BG>
	            </name>
			 </product_group>
			 
		</product_line>

		<product_group copy_from="core.template_normal_transaction" is_abstract="false" tbl="prg">
	 		 <objectdef is_keep_settings="true">
	 		 	<is_hidden>true</is_hidden>
	 		 </objectdef>
	 		 <code is_keep_settings="true">
				<is_unique>true</is_unique>
			 </code>
     		 <product_lines>
                <category>main.basic</category>
                <data_source>relation</data_source>
                <relation_parent>most.product_line.product_group</relation_parent>
                <name>
                    <en-US>Product lines</en-US>
                </name>
                <name>
                    <de-DE>Productlinien</de-DE>
                </name>
                <name>
                    <bg-BG>Придуктови линии</bg-BG>
                </name>
				<display_type>property.relation.multiple.add.new</display_type>
				<relation_filter>core_property_default_relation_filter_simple_bidirectional_relation</relation_filter>
				<sort_id>500</sort_id>
             </product_lines>
		</product_group>
		
		
	</most>
</objectdefs>
</import>